#==============#
#     Kodi     #
#==============#

test_kodi:
  alias: Test Kodi
  
  sequence:
  
    # Send the 'get movies' command to Kodi.
    - service: kodi.call_method
      data:
        entity_id: media_player.kodi
        #method: VideoLibrary.GetMusicVideos
        method: VideoLibrary.GetMovies
    
    # Wait a bit for a good 'get movies' result, but quit if it times out.
    - wait_for_trigger:
        - platform: event
          event_type: test_kodi_result
          #event_data:
          #  source: "{{ wait.trigger.event.data.source }}"
      timeout: 10
      continue_on_timeout: false
        
    - service: system_log.write
      data:
        message: "{{ wait.trigger.event.data.result }}"
        level: warning

test_kodi_video_playlist:
  alias: Test Kodi Video Playlist
  
  sequence:
  
    - service: kodi.call_method
      target:
        entity_id: media_player.kodi
      data:
        method: Playlist.Clear
        playlistid: 1
    
    - wait_for_trigger:
        - platform: event
          event_type: kodi_call_method_result
          event_data:
            result_ok: true
            input:
              method: Playlist.Clear
      timeout: 3
  
    - service: kodi.call_method
      target:
        entity_id: media_player.kodi
      data:
        method: Playlist.Add
        playlistid: 1
        item:
          musicvideoid: 55
    
    - wait_for_trigger:
        - platform: event
          event_type: kodi_call_method_result
          event_data:
            result_ok: true
            input:
              method: Playlist.Add
      timeout: 3
  
    - service: kodi.call_method
      target:
        entity_id: media_player.kodi
      data:
        method: Playlist.Add
        playlistid: 1
        item:
          musicvideoid: 66
    
    - wait_for_trigger:
        - platform: event
          event_type: kodi_call_method_result
          event_data:
            result_ok: true
            input:
              method: Playlist.Add
      timeout: 3
  
    # - service: kodi.call_method
      # target:
        # entity_id: media_player.kodi
      # data:
        # method: Player.Open
        # item:
          # playlistid: 1
    
    # - wait_for_trigger:
        # - platform: event
          # event_type: kodi_call_method_result
          # event_data:
            # result_ok: true
            # input:
              # method: Player.Open
      # timeout: 3

#====================#
#     Thermostat     #
#====================#

test_thermostat_hold:
  alias: Test Thermostat Hold
  
  sequence:
    - service: ecobee.create_vacation
      data_template:
        entity_id: climate.upstairs
        vacation_name: "Temporary"
        start_date: "{{ states('sensor.date') }}"
        start_time: "{{ now().strftime('%H:%M:%S') }}"
        end_date: "{{ (as_timestamp(states('sensor.date')) + 86400) | timestamp_custom('%Y-%m-%d') }}"
        end_time: "{{ now().strftime('%H:%M:%S') }}"
        heat_temp: !secret constant_upstairs_home_heat_temp
        cool_temp: !secret constant_upstairs_home_cool_temp

test_remove_thermostat_hold:
  alias: Test Remove Thermostat Hold
  
  sequence:
    - condition: template
      value_template: "{{ state_attr('climate.upstairs', 'preset_mode') == 'temp' }}"
    - service: ecobee.delete_vacation
      data_template:
        entity_id: climate.upstairs
        vacation_name: "Temporary"

#=================#
#     Bedtime     #
#=================#

test_bedtime_adults_down:
  alias: Test Bedtime Adults Down
  
  sequence:
    - service: input_boolean.turn_on
      entity_id: input_boolean.nighttime
    - service: input_boolean.turn_on
      entity_id: input_boolean.adults_home
    - service: input_boolean.turn_off
      entity_id: input_boolean.children_home
    - service: input_select.select_option
      entity_id: input_select.occupied_bedrooms
      data:
        option: 'AdultDown'
    - service: script.establish_bedtime_environment

test_bedtime_adults_up:
  alias: Test Bedtime Adults Up
  
  sequence:
    - service: input_boolean.turn_on
      entity_id: input_boolean.nighttime
    - service: input_boolean.turn_on
      entity_id: input_boolean.adults_home
    - service: input_boolean.turn_off
      entity_id: input_boolean.children_home
    - service: input_select.select_option
      entity_id: input_select.occupied_bedrooms
      data:
        option: 'AdultUp'
    - service: script.establish_bedtime_environment

test_bedtime_adults_both:
  alias: Test Bedtime Adults Both
  
  sequence:
    - service: input_boolean.turn_on
      entity_id: input_boolean.nighttime
    - service: input_boolean.turn_on
      entity_id: input_boolean.adults_home
    - service: input_boolean.turn_off
      entity_id: input_boolean.children_home
    - service: input_select.select_option
      entity_id: input_select.occupied_bedrooms
      data:
        option: 'Both'
    - service: script.establish_bedtime_environment

test_bedtime_children_down:
  alias: Test Bedtime Children Down
  
  sequence:
    - service: input_boolean.turn_on
      entity_id: input_boolean.nighttime
    - service: input_boolean.turn_off
      entity_id: input_boolean.adults_home
    - service: input_boolean.turn_on
      entity_id: input_boolean.children_home
    - service: input_select.select_option
      entity_id: input_select.occupied_bedrooms
      data:
        option: 'ChildDown'
    - service: script.establish_bedtime_environment

test_bedtime_children_up:
  alias: Test Bedtime Children Up
  
  sequence:
    - service: input_boolean.turn_on
      entity_id: input_boolean.nighttime
    - service: input_boolean.turn_off
      entity_id: input_boolean.adults_home
    - service: input_boolean.turn_on
      entity_id: input_boolean.children_home
    - service: input_select.select_option
      entity_id: input_select.occupied_bedrooms
      data:
        option: 'ChildUp'
    - service: script.establish_bedtime_environment

test_bedtime_children_down_plus:
  alias: Test Bedtime Children Down Plus
  
  sequence:
    - service: input_boolean.turn_on
      entity_id: input_boolean.nighttime
    - service: input_boolean.turn_off
      entity_id: input_boolean.adults_home
    - service: input_boolean.turn_on
      entity_id: input_boolean.children_home
    - service: input_select.select_option
      entity_id: input_select.occupied_bedrooms
      data:
        option: 'ChildDownPlus'
    - service: script.establish_bedtime_environment

test_bedtime_children_up_plus:
  alias: Test Bedtime Children Up Plus
  
  sequence:
    - service: input_boolean.turn_on
      entity_id: input_boolean.nighttime
    - service: input_boolean.turn_off
      entity_id: input_boolean.adults_home
    - service: input_boolean.turn_on
      entity_id: input_boolean.children_home
    - service: input_select.select_option
      entity_id: input_select.occupied_bedrooms
      data:
        option: 'ChildUpPlus'
    - service: script.establish_bedtime_environment

#================#
#     Backup     #
#================#

test_backup_logs:
  alias: Test Backup Logs
  
  sequence:
    - service: shell_command.backup_auto_log

#================#
#     Shield     #
#================#

test_shield_app:
  alias: Test Shield App
  
  sequence:
    - service: androidtv.adb_command
      data:
        entity_id: media_player.shield_tv
        command: "am start -a android.intent.action.MAIN -c android.intent.category.LEANBACK_LAUNCHER -n com.hulu.livingroomplus/.MainActivity"

#================#
#     Notify     #
#================#

test_notify_echo:
  alias: Test Notify Echo
  
  sequence:
    - service: script.send_notification
      data:
        destination:
          - echo
        message: 'Testing 1 2 3'
        media_player_entity: media_player.everywhere

test_notify_persistent:
  alias: Test Notify Persistent
  
  sequence:
    - service: script.send_notification
      data:
        destination:
          - persistent
        title: 'Test:'
        notification_id: 'testing123'
        message: 'Testing 1 2 3'

test_notify_mobile:
  alias: Test Notify Mobile
  
  sequence:    
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Test:'
        message: 'Testing 1 2 3'
        channel: standard
        throttled: false
    
    - delay: '00:00:30'
    
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Test:'
        message: 'Testing 1 2 3'
        channel: temporary
        throttled: false
        timeout: 15
    
    - delay: '00:00:30'
    
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Test:'
        message: 'Testing 1 2 3'
        channel: persistent
        throttled: false
        tag: 'test123'
    
    - delay: '00:00:15'
    
    - service: notify.mobile_app_jon_galaxy
      data:
        message: 'clear_notification'
        data:
          tag: 'test123'
    
    - delay: '00:00:15'
    
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Test:'
        message: 'Testing 1 2 3'
        channel: critical
        throttled: false
        tag: 'testing123'

test_notify_all:
  alias: Test Notify All
  
  sequence:    
    - service: script.send_notification
      data:
        destination:
          - echo
          - persistent
          - mobile
        title: 'Test:'
        message: 'Testing 1 2 3'
        channel: standard
        throttled: false
        media_player_entity: media_player.everywhere
        notification_id: 'testing123'

#==============#
#     Fans     #
#==============#

test_fan_temperature:
  alias: Test Fan Temperature
  
  sequence:
    - service: script.turn_on
      entity_id: script.control_fan_for_temperature
      data:
        variables:
          fan_entity_id: fan.office_fan
          temperature_entity_id: sensor.office_temperature
          thresholds: [78, 72, 68]
          timeout: 30

#==================#
#     Exercise     #
#==================#

test_exercise_reset:
  alias: Test Exercise Reset
  
  sequence:
    - service: input_boolean.turn_off
      target:
        entity_id:
          - input_boolean.treadmill_sun
          - input_boolean.workout_sun

test_number_reset:
  alias: Test Number Reset
  
  sequence:
    - service: input_number.set_value
      target:
        entity_id:
          - input_number.workout_daily_time
          - input_number.yard_work_daily_time
      data:
        value: 0

#=================#
#     Laundry     #
#=================#

test_laundry_events:
  alias: Test Laundry Events
  
  sequence:
    - service: script.log_laundry_event
      data:
        event_type: basic
        prefix: Washer
        message: started
    
    - service: script.log_laundry_event
      data:
        event_type: metric
        prefix: Dryer
        message: temperature detected
        entity_id_1: sensor.dryer_temperature 
    
    - service: script.log_laundry_event
      data:
        event_type: metric_plus_gradient
        prefix: Dryer
        message: temperature
        entity_id_1: sensor.dryer_temperature
        entity_id_2: binary_sensor.dryer_temperature_falling
    
    - service: script.log_laundry_event
      data:
        event_type: fill_plus_load
        prefix: Washer
        message: fill time, load size
        entity_id_1: input_number.washer_fill_seconds
        entity_id_2: input_select.washer_load_size
    
    - service: script.log_laundry_event
      data:
        event_type: timer
        prefix: Washer
        message: timer started
        entity_id_1: timer.washer_wash_blackout

#==========================#
#     Friendly Strings     #
#==========================#

test_friendly_time:
  alias: Test Friendly Time
  
  sequence:
    - service: script.send_notification
      data:
        destination:
          - persistent
        title: 'Test:'
        notification_id: 'test_friendly'
        message: >
          {% from 'friendly_strings.jinja' import format_duration %}
          {{ format_duration(state_attr('input_datetime.reminder_cleaning_guest_bath', 'timestamp')) }}

#================#
#     Lights     #
#================#

test_light_flash:
  alias: Test Light Flash
  
  sequence:
        
    - repeat:
        count: 3
        sequence:
    
          - service: light.turn_on
            entity_id: light.foyer_hutch
          
          - delay: 2
    
          - service: light.turn_off
            entity_id: light.foyer_hutch
          
          - delay: 2

#=======================================#
#     Alexa Actionable Notification     #
#=======================================#

test_alexa_actionable_notification:
  alias: Test Alexa Actionable Notification
  
  sequence:
    - service: script.activate_alexa_actionable_notification
      data:
        message: Would you like me to flash the light?
        event_id: actionable_notification_flash_light
        alexa_device: media_player.office_echo
        suppress_confirmation: false

#=======================#
#     Dynamic Group     #
#=======================#

test_group_create:
  alias: Test Group Create
  
  sequence:
    service: group.set
    data:
      name: Test Group
      object_id: test_group
      entities:
        - light.family_room_lamp
        - light.hallway_lamp

test_group_modify:
  alias: Test Group Modify
  
  sequence:
    service: group.set
    data:
      name: Test Group
      object_id: test_group
      entities:
        - light.family_room_lamp
        - light.hallway_lamp
        - light.guest_bath_light

test_group_remove:
  alias: Test Group Remove
  
  sequence:
    service: group.remove
    data:
      object_id: test_group
