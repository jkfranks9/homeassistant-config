#=======================#
#     Notifications     #
#=======================#

# Throttle mobile notifications so that only one per day is issued. This is accomplished by using
# a timer associated with the particular notification. We only proceed if the timer is idle. Then
# we start the timer with a duration that ends at 7 AM the next day.
#
# Note that we rely on timers being saved and restored over a restart. Since we can't be certain 
# of the order of those automations vs the automations that drive this script, the timer restoration
# automation sets a switch once complete, and we wait for that switch to be set before continuing, 
# thus ensuring that any running timers are once again active before we check them.
throttle_mobile_notification:
  alias: Throttle Mobile Notification
  mode: queued
  max: 10
  
  fields:
    timer_entity:
      description: 'The controlling timer entity used to throttle the notification.'
      example: 'timer.vac'
    title:
      description: 'The title of the message.'
      example: 'Warning:'
    message:
      description: 'The message to be issued.'
      example: 'This is only a test, do not be alarmed.'
    channel:
      description: 'The channel to which the notification is issued.'
      example: 'Home Assistant'
  
  sequence:
    
    # Ensure timers have been restored after a restart.
    - wait_template: "{{ is_state('input_boolean.timers_restored', 'on') }}"
    
    # Wait a few more seconds just in case.
    - delay: '00:00:03'
    
    # Only continue if the input timer is idle.
    - condition: "{{ is_state(timer_entity, 'idle') }}"
    
    # Send the notification.
    - service: notify.mobile_app_jon_galaxy
      data:
        title: "{{ title }}"
        message: "{{ message }}"
        data:
          channel: "{{ channel }}"
    
    # Start the timer, using a duration that ends tomorrow at 7 AM.
    - service: timer.start
      data:
        entity_id: "{{ timer_entity }}"
        duration: >
          {% set next = now().today().replace(hour=7, minute=0, second=0, microsecond=0) + timedelta(days = 1) %}
          {{ (next - now().today().replace(microsecond=0)).seconds }}
