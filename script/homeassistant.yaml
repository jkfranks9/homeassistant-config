#===================#
#     Utilities     #
#===================#

# Concatenate a set of backup log files into one file for easier examination.
concat_log_files:
  alias: Concat Log Files
  sequence:
    - service: shell_command.concat_log_files

# Concatenate a set of automation log files into one file for easier examination.
concat_auto_log_files:
  alias: Concat Auto Log Files
  sequence:
    - service: shell_command.concat_auto_log_files

# Concatenate a set of scripts log files into one file for easier examination.
concat_scripts_log_files:
  alias: Concat Scripts Log Files
  sequence:
    - service: shell_command.concat_scripts_log_files

#===================#
#     Reminders     #
#===================#

# Set an input datetime entity with an offset in days.
set_datetime_offset_days:
  alias: Set Datetime Offset Days
  sequence:
    - service: input_datetime.set_datetime
      data:
        entity_id: "{{ entity }}"
        datetime: "{{ now().today().replace(hour=0, minute=0, second=0, microsecond=0) + timedelta(days = interval) }}"

# Set an input datetime entity with an offset in weeks.
set_datetime_offset_weeks:
  alias: Set Datetime Offset Weeks
  sequence:
    - service: input_datetime.set_datetime
      data:
        entity_id: "{{ entity }}"
        datetime: "{{ now().today().replace(hour=0, minute=0, second=0, microsecond=0) + timedelta(weeks = interval) }}"

# Set an input datetime entity with an offset in months.
set_datetime_offset_months:
  alias: Set Datetime Offset Months
  sequence:
    - service: input_datetime.set_datetime
      data:
        entity_id: '{{ entity }}'
        datetime: >
          {%- set dtobj=now().fromtimestamp(as_timestamp(states(entity))) %}
          {%- set sub_months=((dtobj.year) * 12 + (dtobj.month + interval - 1)) %}
          {%- set new_months=((sub_months) % 12) + 1 %}
          {%- set new_year=((sub_months - new_months + 1) / 12) | int(0) %}
          {{ dtobj.replace(month=new_months, year=new_year) }}

#=================#
#     Adguard     #
#=================#

# These are used for automatic control of Adguard for different Shield applications, and for voice
# control via Alexa.
turn_off_adguard:
  alias: Turn Off Adguard
  sequence:
    - service: switch.turn_off
      entity_id: switch.adguard_protection

turn_on_adguard:
  alias: Turn On Adguard
  sequence:
    - service: switch.turn_on
      entity_id: switch.adguard_protection

#========================#
#     MQTT Discovery     #
#========================#

# Publish state & attributes for MQTT last changed sensors.
publish_mqtt_automated_states:
  alias: Publish MQTT Automated States
  mode: parallel
  
  fields: 
    <<: &mqtt_fields
      domain:
        description: The entity domain.
        selector:
          text:
            type: text
      
      unique_id:
        description: The entity ID.
        selector:
          text:
            type: text
    
    state:
      description: The entity state.
      selector:
        text:
          type: text
    
    attributes:
      description: The entity attributes.
      example: A dictionary {} in yaml
      selector:
        object:
  
  variables: 
    <<: &mqtt_variables
      root: "homeassistant"
      
      topic_root: >
        {%- if domain is not defined or unique_id is not defined %}
          {{- [ root, 'error'] | join('/') }}
        {%- else %}
          {{- [ root, domain, unique_id ] | join('/') }}
        {%- endif %}
    
    service_data: >
      {{ {
        'topic': topic_root ~ '/state',
        'payload': '' ~ { 'state': state, 'attributes': attributes | default({}) } | tojson,
        'retain': retain | default('true')
      } }}

  sequence:
    - service: mqtt.publish
      data: "{{ service_data }}"

# Set up MQTT discovery sensors to keep track of the last changed time for interesting entities.
set_up_mqtt_automated_config:
  alias: Set Up MQTT Automated Config
  mode: parallel
  
  fields: 
    <<: *mqtt_fields
    device_class: 
      description: The entity device class.
      selector:
        text:
          type: text
  
  variables:
    name: >
      {{ unique_id | default('') | replace('_', ' ') | title }}
    
    <<: *mqtt_variables
    
    service_data: >
      {%- set items = [
        ( "name", name),
        ( "unique_id", unique_id | default(none)),
        ( "state_topic", topic_root ~ "/state"),
        ( "value_template", "{{ value_json.state }}"),
        ( "json_attributes_topic", topic_root ~ "/state"),
        ( "json_attributes_template", "{{ value_json.attributes | tojson }}"),
        ( "device_class", device_class | default(none) ),
      ] %}
      {% set payload = dict.from_keys(items | rejectattr('1', 'none') | list) %}
      {{ {
        'topic': topic_root ~ '/config',
        'payload': '' ~ payload | tojson,
      } }}
  
  sequence:
    - service: mqtt.publish
      data: "{{ service_data }}"

#=======================#
#     Debug Logging     #
#=======================#

# Log laundry events to assist with debugging.
log_laundry_event:
  alias: Log Laundry Event
  
  fields:
    event_type:
      description: The type of event to be logged.
      selector:
        select:
          options:
            - basic
            - metric
            - metric_plus_gradient
            - fill_plus_load
            - timer
    
    prefix:
      description: The message prefix that indicates a washer or dryer event.
    
    message:
      description: The message to be logged.
    
    entity_id_1:
      description: The first entity required (if any) for the message.
    
    entity_id_2:
      description: The second entity required (if any) for the message.
  
  sequence:
    - variables:
        timestamp: "{{ as_timestamp(now()) | timestamp_custom('%b %d %Y %X') }}:"
    
    # Take action based on the event type.
    - choose:
      
      # A basic message just has a text component.
      - conditions: "{{ event_type == 'basic' }}"
        
        sequence:
          - service: notify.laundry_events
            data_template:
              message: "{{ timestamp }} {{ prefix }} {{ message }}"
    
      # A metric message adds a single metric, such as a temperature or humidity.
      - conditions: "{{ event_type == 'metric' }}"
        
        sequence:
          - service: notify.laundry_events
            data_template:
              message: "{{ timestamp }} {{ prefix }} {{ message }} ({{ states(entity_id_1) }})"
    
      # A metric plus gradient message includes both a single metric plus a trend sensor gradient. Obviously this only applies to the dryer.
      - conditions: "{{ event_type == 'metric_plus_gradient' }}"
        
        sequence:
          - service: notify.laundry_events
            data_template:
              message: "{{ timestamp }} {{ prefix }} {{ message }} ({{ states(entity_id_1) }}) {{ state_attr(entity_id_2, 'gradient') | round(5) }}"
    
      # A fill plus load message includes both the washer fill seconds and calculated load size.
      - conditions: "{{ event_type == 'fill_plus_load' }}"
        
        sequence:
          - service: notify.laundry_events
            data_template:
              message: "{{ timestamp }} {{ prefix }} {{ message }} {{ states(entity_id_1) }}, {{ states(entity_id_2) }}"
    
      # A timer message indicates the name of the timer.
      - conditions: "{{ event_type == 'timer' }}"
        
        sequence:
          - service: notify.laundry_events
            data_template:
              message: "{{ timestamp }} {{ prefix }} {{ message }}: {{ state_attr(entity_id_1, 'friendly_name') }}"
            
      # Should not occur.
      default:
          
        - service: system_log.write
          data:
            message: "Event type invalid value ({{ event_type }})"
            level: error
