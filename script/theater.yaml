#===========================#
#     Cinema Open/Close     #
#===========================#

# Open the cinema to turn on some lights and warm up the projector and receiver.
open_cinema:
  alias: Open Cinema
  sequence:
    
    # Turn on the necessary devices.
    - service: switch.turn_on
      entity_id: switch.harmony_hub_open_cinema
    
    # Turn on some lights.
    - service: script.turn_on
      entity_id: script.set_theater_idle
    
    # Turn on the fan if needed.
    - service: script.turn_on
      entity_id: script.turn_on_theater_fan
    
    # Turn off the family room AV system.
    - service: script.disable_family_room_av
    
    # Set the upstairs Ecobee to home mode if it's not there already. Note that the mode could be lower case if
    # we're in smart home mode.
    - condition: template
      value_template: >
        {% set mode = state_attr('climate.upstairs', 'preset_mode') | title %}
        {{ mode != 'Home' }}
    - service: climate.set_preset_mode
      target:
        entity_id: climate.upstairs
      data:
        preset_mode: 'Home'
    
    # If no family are home, delay, then turn off some downstairs lights.
    - delay: '00:05:00'
    - service: script.change_some_downstairs_lights
      data:
        turn_on: false

# Close the cinema by turning off the current harmony activity, and relevant lights after a delay.
#
# NOTE: We're also called by the close_cinema automation ... some steps taken here are superfluous
#       in that context, such as turning the remote off, but should do no harm.
close_cinema:
  alias: Close Cinema
  sequence:
    
    # Turn on some lights.
    - service: script.turn_on
      entity_id: script.set_theater_idle
    
    # Turn off the fan.
    - service: fan.turn_off
      entity_id: fan.theater_fan
    
    # Turn off the Kodi media player (it might not be on but that's OK).
    - service: media_player.turn_off
      data:
        entity_id: media_player.kodi
    
    # Turn off all devices.
    - delay: '00:00:02'
    - service: remote.turn_off
      entity_id: remote.harmony_hub
    
    # Set the upstairs Ecobee to away or sleep mode, depending on the time of day.
    - choose:
      - conditions:
        - condition: time
          after:  '18:30:00'
          before: '23:30:00'
        sequence:
          - service: climate.set_preset_mode
            target:
              entity_id: climate.upstairs
            data:
              preset_mode: 'Sleep'
      default:
        - service: climate.set_preset_mode
          target:
            entity_id: climate.upstairs
          data:
            preset_mode: 'Away'
    
    # Turn Adguard protection on in case it was turned off (for example for Paramount Plus).
    - service: script.turn_on_adguard
    
    # Turn off all lights.
    - delay: '00:05:00'
    - service: script.turn_on
      entity_id: script.set_theater_dark

#===========================#
#     Theater Lighting      #
#===========================#

# Make the theater dark.
set_theater_dark:
  alias: Set Theater Dark
  sequence:
    - scene: scene.theater_aux_dark
    - scene: scene.lutron_dark

# Make the theater dark, with a delay.
set_theater_dark_delay:
  alias: Set Theater Dark Delay
  sequence:
    - scene: scene.theater_aux_dark
    - delay: '00:00:12'
    - scene: scene.lutron_dark

# Make the theater dim.
set_theater_dim:
  alias: Set Theater Dim
  sequence:
    - scene: scene.theater_aux_dark
    - scene: scene.lutron_dim

# Make the theater bright.
set_theater_bright:
  alias: Set Theater Bright
  sequence:
    - scene: scene.theater_aux_partial
    - service: script.change_some_downstairs_lights
      data:
        turn_on: true
    - scene: scene.lutron_bright

# Make the theater idle, meaning it's on but we need lights to see.
set_theater_idle:
  alias: Set Theater Idle
  sequence:
    - scene: scene.theater_aux_partial
    - scene: scene.lutron_idle
    - service: script.change_some_downstairs_lights
      data:
        turn_on: true

#======================#
#     Theater Fan      #
#======================#

# Turn on the theater fan if it's warm enough.
turn_on_theater_fan:
  alias: Turn On Theater Fan
  sequence:
    - condition: numeric_state
      entity_id: sensor.theater_temperature
      above: 75.0
    - service: fan.turn_on
      entity_id: fan.theater_fan

#============================#
#     Downstairs Lights      #
#============================#

# Turn on some downstairs lights if it's dark enough, or conditionally turn them off. This is used by the open/close cinema scripts,
# and the 'take a break' scipt, because we might need to go downstairs at these times.
change_some_downstairs_lights:
  alias: Change Some Downstairs Lights
  fields:
    turn_on:
      description: Whether to turn the lights on (true) or off (false).
  
  sequence:
    - choose:
      
      # Turn on lights.
      - conditions:
        - condition: template
          value_template: "{{ turn_on == true }}"
        
        sequence:
          - condition: numeric_state
            entity_id: sun.sun
            attribute: elevation
            below: 4.0
          - service: homeassistant.turn_on
            entity_id:
              - light.stairway_light
              - light.family_room_lamp
              - light.hallway_lamp
        
      # Turn off lights, but only if no family members present.
      default:
        - condition: state
          entity_id: group.family_members
          state: 'not_home'
        - service: homeassistant.turn_off
          entity_id:
            - light.stairway_light
            - light.family_room_lamp
            - light.hallway_lamp

#==============================#
#     Watch Shield TV App      #
#==============================#

# Template script that does the work.
watch_app:
  alias: Watch Application
  fields:
    component:
      description: 'The component name of the target Shield TV application. These are obtained by querying the Shield TV box.'
      example: 'com.netflix.ninja/.MainActivity'
    lighting:
      description: 'Script or scene that establishes the desired lighting.'
      example: 'script.set_theater_dark'
  
  sequence:
    
    # Turn on some lights.
    - service: script.set_theater_idle
  
    # First, turn on the harmony activity that ensures the projector, receiver and Shield TV are powered on. The receiver at this 
    # point is switched to an unused input so the screen will be dark.
    - service: switch.turn_on
      entity_id: switch.harmony_hub_enable_streaming
    
    # After a short delay, bring up the target application on the Shield TV.
    - delay: '00:00:03'
    - service: androidtv.adb_command
      data:
        entity_id: media_player.shield_tv
        command: "am start -a android.intent.action.MAIN -c android.intent.category.LEANBACK_LAUNCHER -n {{ component }}"
  
    # Now switch the receiver to the proper input so the application can be viewed on screen.
    - service: remote.send_command
      entity_id: remote.harmony_hub
      data:
        command: 'InputCbl/Sat'
        device: Marantz Receiver
  
    # Establish the target lighting.
    - service: "{{ lighting }}"

#------------------------#
#   -- Applications --   #
#------------------------#

# Amazon Prime
watch_amazon_prime:
  alias: Watch Amazon Prime
  sequence:
    - service: script.watch_app
      data:
        component: 'com.amazon.amazonvideo.livingroom/com.amazon.ignition.IgnitionActivity'
        lighting: 'script.set_theater_dark_delay'

# Disney Plus
watch_disney_plus:
  alias: Watch Disney Plus
  sequence:
    - service: script.watch_app
      data:
        component: 'com.disney.disneyplus/com.bamtechmedia.dominguez.main.MainActivity'
        lighting: 'script.set_theater_dark_delay'

# HBO Max
watch_hbo_max:
  alias: Watch HBO Max
  sequence:
    - service: script.watch_app
      data:
        component: 'com.hbo.hbonow/com.hbo.go.LaunchActivity'
        lighting: 'script.set_theater_dark_delay'

# Kodi
watch_kodi:
  alias: Watch Kodi
  sequence:
    - service: script.watch_app
      data:
        component: 'org.xbmc.kodi/.Splash'
        lighting: 'script.set_theater_dark_delay'

# Netflix
watch_netflix:
  alias: Watch Netflix
  sequence:
    - service: script.watch_app
      data:
        component: 'com.netflix.ninja/.MainActivity'
        lighting: 'script.set_theater_dark_delay'

# Pandora
watch_pandora:
  alias: Watch Pandora
  sequence:
    - service: script.watch_app
      data:
        component: 'com.pandora.android.atv/com.pandora.android.MainActivity'
        lighting: 'script.set_theater_dim'

# Paramount Plus
watch_paramount_plus:
  alias: Watch Paramount Plus
  sequence:
    - service: script.watch_app
      data:
        component: 'com.cbs.ott/com.cbs.app.tv.ui.activity.SplashActivity'
        lighting: 'script.set_theater_dark_delay'

# Peacock
watch_peacock:
  alias: Watch Peacock
  sequence:
    - service: script.watch_app
      data:
        component: 'com.peacocktv.peacockandroid/com.peacock.peacocktv.GoogleMainActivity'
        lighting: 'script.set_theater_dark_delay'

# Youtube TV
watch_youtube_tv:
  alias: Watch Youtube TV
  sequence:
    - service: script.watch_app
      data:
        component: 'com.google.android.youtube.tvunplugged/com.google.android.apps.youtube.tvunplugged.activity.MainActivity'
        lighting: 'script.set_theater_dark_delay'

#=============================#
#     Harmony Activities      #
#=============================#

# Template script that does the work.
start_activity:
  alias: Start Activity
  fields:
    activity:
      description: 'The Harmony activity name to be started.'
      example: 'BD Player'
    lighting:
      description: 'Script or scene that establishes the desired lighting.'
      example: 'script.set_theater_dark'
  
  sequence:
  
    # Turn on the target activity.
    - service: remote.turn_on
      entity_id: remote.harmony_hub
      data:
        activity: "{{ activity }}"
  
    # Establish the target lighting.
    - service: "{{ lighting }}"

#----------------------#
#   -- Activities --   #
#----------------------#

# Shield TV (streaming)
start_streaming:
  alias: Start Streaming
  sequence:
    - service: script.start_activity
      data:
        activity: 'Stream Player'
        lighting: 'script.set_theater_dark_delay'

# Blu-ray
start_bluray:
  alias: Start Bluray
  sequence:
    - service: script.start_activity
      data:
        activity: 'BD Player'
        lighting: 'script.set_theater_dark_delay'

# Laserdisc
start_laserdisc:
  alias: Start Laserdisc
  sequence:
    - service: script.start_activity
      data:
        activity: 'LD Player'
        lighting: 'script.set_theater_dark_delay'

# Turntable
start_turntable:
  alias: Start Turntable
  sequence:
    - service: script.start_activity
      data:
        activity: 'LP Player'
        lighting: 'script.set_theater_dim'

#========================#
#     Cinema Resume      #
#========================#

# Resume the current harmony activity and restore the lighting.

# Worker script
resume_worker:
  alias: Resume Worker
  fields:
    device:
      description: 'The Harmony device name to be resumed.'
      example: 'Sony DVD/Blu-ray Player'
  
  sequence:
  
    # Send the play command to the target device.
    - service: remote.send_command
      entity_id: remote.harmony_hub
      data:
        command: Play
        device: "{{ device }}"
  
    # Establish 'dark' theater lighting.
    - service: script.turn_on
      entity_id: script.set_theater_dark
    
    # Turn off some downstairs lights.
    - service: script.change_some_downstairs_lights
      data:
        turn_on: false

# Call the worker script with the appropriate device based on the Harmony activity.
# Note: The turntable cannot be controlled, so all we do is turn on some lights.
resume_cinema:
  alias: Resume Cinema
  sequence:
    - choose:
      - conditions:
        - condition: template
          value_template: >
            {{ is_state('sensor.harmony_hub', 'Stream Player') or
               is_state('sensor.harmony_hub', 'Enable Streaming') }}
        sequence:
          - service: script.resume_worker
            data:
              device: 'NVIDIA Shield TV'
      - conditions:
        - condition: template
          value_template: "{{ is_state('sensor.harmony_hub', 'BD Player') }}"
        sequence:
          - service: script.resume_worker
            data:
              device: 'Sony DVD/Blu-ray Player'
      - conditions:
        - condition: template
          value_template: "{{ is_state('sensor.harmony_hub', 'LD Player') }}"
        sequence:
          - service: script.resume_worker
            data:
              device: 'Panasonic Laserdisc Player'
      - conditions:
        - condition: template
          value_template: "{{ is_state('sensor.harmony_hub', 'LP Player') }}"
        sequence:
          - service: script.turn_on
            entity_id: script.set_theater_dim
      default:
        - service: system_log.write
          data:
            message: Current activity does not support resume command.
            level: warning

#============================#
#     Kodi Movie Control     #
#============================#

# Get the list of all movies known by Kodi.
# This script is only needed when the Kodi movie library is updated, and the Shield TV is off (we don't want
# to randomly switch apps if the media player is in use).
get_all_kodi_movies:
  alias: Get All Kodi Movies
  sequence:
    - condition: state
      entity_id: media_player.shield_tv
      state: 'off'
  
    # Turn on the Shield TV so we can host the Kodi application.
    - service: media_player.turn_on
      data:
        entity_id: media_player.shield_tv
    - delay: '00:00:03'
  
    # Start Kodi on the Shield TV.
    - service: androidtv.adb_command
      data:
        entity_id: media_player.shield_tv
        command: "am start -a android.intent.action.MAIN -c android.intent.category.LEANBACK_LAUNCHER -n 'org.xbmc.kodi/.Splash'"
    - delay: '00:00:02'
  
    # Send the 'get movies' command to Kodi.
    - service: kodi.call_method
      data:
        entity_id: media_player.kodi
        method: VideoLibrary.GetMovies
    
    # Wait a bit for a good 'get movies' result, but quit if it times out.
    - wait_for_trigger:
        - platform: event
          event_type: kodi_call_method_result
          event_data:
            result_ok: 'True'
            input:
              method: VideoLibrary.GetMovies
      timeout: 10
      continue_on_timeout: false
    
    # Call the python script to populate the input select.
    - service: pyscript.populate_all_movies
      data:
        entity: input_select.kodi_movies
        result: "{{ trigger.event.data.result }}"
  
    # Exit the Kodi application.
    - service: remote.send_command
      entity_id: remote.harmony_hub
      data:
        command: 'Home'
        device: NVIDIA Shield TV
    - delay: '00:00:02'
    
    # Turn off the Kodi media player.
    - service: media_player.turn_off
      data:
        entity_id: media_player.kodi
  
    # Turn the Shield TV off again.
    - service: media_player.turn_off
      data:
        entity_id: media_player.shield_tv

#===========================#
#     Kodi Play Feature     #
#===========================#

# Play feature movie! 
play_feature_movie:
  alias: Play Feature Movie
  sequence:
    
    # Turn on some lights.
    - service: script.set_theater_idle
  
    # Start the 'enable streaming' Harmony activity, which ensures the correct devices are on and the screen is dark.
    - service: switch.turn_on
      entity_id: switch.harmony_hub_enable_streaming
    - delay: '00:00:03'
  
    # Start Kodi on the Shield TV.
    - service: androidtv.adb_command
      data:
        entity_id: media_player.shield_tv
        command: "am start -a android.intent.action.MAIN -c android.intent.category.LEANBACK_LAUNCHER -n 'org.xbmc.kodi/.Splash'"
    - delay: '00:00:02'
  
    # Send the 'get movies' command to Kodi, with the target movie name.
    - service: kodi.call_method
      data:
        entity_id: media_player.kodi
        method: VideoLibrary.GetMovies
        filter:
          field: title
          operator: is
          value: "{{ states('input_select.kodi_movies') }}"
        limits:
          end: 1
          start: 0
    
    # Wait a bit for a good 'get movies' result, but quit if it times out.
    - wait_for_trigger:
        - platform: event
          event_type: kodi_call_method_result
          event_data:
            result_ok: 'True'
            input:
              method: VideoLibrary.GetMovies
      timeout: 10
      continue_on_timeout: false
    
    # Pick up the movie ID.
    - variables:
        movieid: "{{ trigger.event.data.result.movies.0.movieid }}"
  
    # Now switch the receiver to the proper input so Kodi can be viewed on screen.
    - service: remote.send_command
      entity_id: remote.harmony_hub
      data:
        command: 'InputCbl/Sat'
        device: Marantz Receiver
  
    # Tell Kodi to play the feature.
    - service: kodi.call_method
      data_template:
        entity_id: media_player.kodi
        method: Player.Open
        item:
          movieid: "{{ movieid }}"
  
    # Darken the theater.
    - service: script.turn_on
      entity_id: script.set_theater_dark_delay
 
#=======================#
#     Turn Off Kodi     #
#=======================#
turn_off_kodi:
  alias: Turn Off Kodi
  sequence:
    - service: kodi.call_method
      target:
        entity_id: media_player.kodi
      data:
        method: Application.Quit
