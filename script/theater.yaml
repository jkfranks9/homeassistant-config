#===========================#
#     Cinema Open/Close     #
#===========================#

# Open the cinema to turn on some lights and warm up the projector and receiver.
open_cinema:
  alias: Open Cinema
  sequence:
    
    # Turn on the necessary devices.
    - service: switch.turn_on
      entity_id: switch.harmony_hub_open_cinema
    
    # Turn on some lights.
    - service: script.turn_on
      entity_id: script.set_theater_idle
    
    # Say something appropriate.
    - service: notify.alexa_media
      data:
        message: "{{ ['Cinema is open for business!', 
                      'Enjoy the show!', 
                      'Theater is ready!'
                     ] | random }}"
        target:
          - media_player.family_room_echo
          - media_player.theater_echo
        data:
          type: tts
    
    # Turn on the fan if needed.
    - service: script.turn_on
      entity_id: script.control_fan_for_temperature
      data:
        variables:
          fan_entity_id: fan.theater_fan
          temperature_entity_id: sensor.theater_temperature
          timeout: 0
    
    # Set the upstairs Ecobee to home mode.
    - service: script.set_thermostat_preset
      data:
        thermostat_entity: climate.upstairs
        preset: 'Home'
    
    # Indicate the theater is open.
    - service: input_boolean.turn_on
      entity_id: input_boolean.theater_open
    
    # If no family are home, delay, then turn off some downstairs lights.
    - delay: '00:05:00'
    - service: script.change_downstairs_lighting
      data:
        turn_on: false
        christmas: true
    
    # Turn off the family room AV system if it's late enough and no one else is home.
    - condition:
        - condition: state
          entity_id: 
            - input_boolean.adults_home
            - input_boolean.children_home
          state: 'off'
        - condition: time
          after:  '18:00:00'
          before: '23:30:00'
    - service: script.disable_family_room_av

# Close the cinema by turning off the current harmony activity, and relevant lights after a delay.
#
# NOTE: We're also called by the close_cinema automation ... some steps taken here are superfluous
#       in that context, such as turning the remote off, but should do no harm.
close_cinema:
  alias: Close Cinema
  sequence:
    
    # Indicate the theater is closed.
    - service: input_boolean.turn_off
      entity_id: input_boolean.theater_open
    
    # Turn on automations/lights that were possibly turned off by the open cinema script.
    - service: script.change_downstairs_lighting
      data:
        turn_on: true
        christmas: false
    
    # Turn on some lights. There's some overlap in entities with the above service, but that's OK.
    - service: script.turn_on
      entity_id: script.set_theater_idle
    
    # Turn off the fan.
    - service: script.turn_off_fan
      data:
        entity_id: fan.theater_fan
    
    # Turn off the Kodi media player (it might not be on but that's OK).
    - service: media_player.turn_off
      data:
        entity_id: media_player.kodi
    
    # Turn off all devices.
    - delay: '00:00:02'
    - service: remote.turn_off
      entity_id: remote.harmony_hub
    
    # Set the upstairs Ecobee to away or sleep mode, depending on the time of day.
    - if:
        - condition: time
          after:  '18:30:00'
          before: '23:30:00'
        
      then:
          
        - service: script.set_thermostat_preset
          data:
            thermostat_entity: climate.upstairs
            preset: 'Sleep'
      
      else:
        
        - service: script.set_thermostat_preset
          data:
            thermostat_entity: climate.upstairs
            preset: 'Away'
    
    # Turn Adguard protection on in case it was turned off (for example for Paramount Plus).
    - service: script.turn_on_adguard
    
    # Turn off all lights.
    - delay: '00:05:00'
    - service: script.turn_on
      entity_id: script.set_theater_dark

#===========================#
#     Theater Lighting      #
#===========================#

# Make the theater dark.
set_theater_dark:
  alias: Set Theater Dark
  sequence:
    - scene: scene.theater_aux_dark
    - scene: scene.lutron_dark

# Make the theater dark, with a delay.
set_theater_dark_delay:
  alias: Set Theater Dark Delay
  sequence:
    - scene: scene.theater_aux_dark
    - delay: '00:00:12'
    - scene: scene.lutron_dark

# Make the theater dim.
set_theater_dim:
  alias: Set Theater Dim
  sequence:
    - scene: scene.theater_aux_dark
    - scene: scene.lutron_dim

# Make the theater bright.
set_theater_bright:
  alias: Set Theater Bright
  sequence:
    - scene: scene.theater_aux_partial
    - service: script.change_downstairs_lighting
      data:
        turn_on: true
        christmas: false
    - scene: scene.lutron_bright

# Make the theater idle, meaning it's on but we need lights to see.
set_theater_idle:
  alias: Set Theater Idle
  sequence:
    - scene: scene.theater_aux_partial
    - scene: scene.lutron_idle
    - service: script.change_downstairs_lighting
      data:
        turn_on: true
        christmas: false

#============================#
#     Downstairs Lights      #
#============================#

# Turn on some downstairs lights if it's dark enough, or conditionally turn them off. This is used as follows,
# either directly or via the Set Theater Idle script:
#
# - The Open Cinema script (turn on, delay, turn off)
# - The Close Cinema script (turn on)
# - The Alexa Break Time routine, which calls Set Theater Idle (turn on)
# - The Restore Lighting On Resume script (turn off)
change_downstairs_lighting:
  alias: Change Downstairs Lighting
  fields:
    turn_on:
      description: Whether to turn the lights on (true) or off (false).
    
    christmas:
      description: Whether to change the Christmas lights (true) or not (false).
  
  sequence:
    - if:
      
        # Turn on lights.
        - "{{ turn_on == true }}"
        
      then:
          
        # Turn on automations that might have been turned off.
        - service: automation.turn_on
          entity_id:
            - automation.check_daytime_lights_sunset_minimum
            - automation.check_daytime_lights_sunset_medium
            - automation.check_daytime_lights_sunset_maximum
          
        # Turn on lights. The use of the sun elevation angle here is a crude approximation of the Weather Based Light At Sunset blueprint.
        - condition: numeric_state
          entity_id: sun.sun
          attribute: elevation
          below: 4.0
    
        - service: light.turn_on
          data_template:
            entity_id: >
              {% if states('input_boolean.christmas_mode') == 'off' or (christmas == false) %}
                {{ 'light.daytime_lights' }}
              {% else %}
                {{ ['light.hallway_lamp', 'light.indoor_christmas_lights'] }}
              {% endif %}
        
        - service: light.turn_on
          entity_id:
            - light.stairway_light
            - light.island_light
        
      # Turn off lights, but only if no family members present.
      else:
        - condition: state
          entity_id: input_boolean.adults_home
          state: 'off'
        
        # First, turn off automations that might turn on some of these lights.
        - service: automation.turn_off
          entity_id:
            - automation.check_daytime_lights_sunset_minimum
            - automation.check_daytime_lights_sunset_medium
            - automation.check_daytime_lights_sunset_maximum    
        
        # Now, turn them off.
        - service: light.turn_off
          data_template:
            entity_id: >
              {% if states('input_boolean.christmas_mode') == 'off' or (christmas == false) %}
                {{ 'light.daytime_lights' }}
              {% else %}
                {{ ['light.hallway_lamp', 'light.indoor_christmas_lights'] }}
              {% endif %}
        
        - service: light.turn_off
          entity_id: 
            - light.stairway_light
            - light.island_light

#==============================#
#     Watch Shield TV App      #
#==============================#

# Template script that does the work.
watch_app:
  alias: Watch Application
  fields:
    component:
      description: 'The component name of the target Shield TV application. These are obtained by querying the Shield TV box.'
      example: 'com.netflix.ninja/.MainActivity'
    lighting:
      description: 'Script or scene that establishes the desired lighting.'
      example: 'script.set_theater_dark'
  
  sequence:
    
    # Turn on some lights.
    - service: script.set_theater_idle
  
    # First, turn on the harmony activity that ensures the projector, receiver and Shield TV are powered on. The receiver at this 
    # point is switched to an unused input so the screen will be dark.
    - service: switch.turn_on
      entity_id: switch.harmony_hub_enable_streaming
    
    # After a short delay, bring up the target application on the Shield TV.
    - delay: '00:00:03'
    - service: androidtv.adb_command
      data:
        entity_id: media_player.shield_tv
        command: "am start -a android.intent.action.MAIN -c android.intent.category.LEANBACK_LAUNCHER -n {{ component }}"
  
    # Now switch the receiver to the proper input so the application can be viewed on screen.
    - service: remote.send_command
      entity_id: remote.harmony_hub
      data:
        command: 'InputCbl/Sat'
        device: Marantz Receiver
  
    # Establish the target lighting.
    - service: "{{ lighting }}"

#------------------------#
#   -- Applications --   #
#------------------------#

# Amazon Prime
watch_amazon_prime:
  alias: Watch Amazon Prime
  sequence:
    - service: script.watch_app
      data:
        component: 'com.amazon.amazonvideo.livingroom/com.amazon.ignition.IgnitionActivity'
        lighting: 'script.set_theater_dark_delay'

# Disney Plus
watch_disney_plus:
  alias: Watch Disney Plus
  sequence:
    - service: script.watch_app
      data:
        component: 'com.disney.disneyplus/com.bamtechmedia.dominguez.main.MainActivity'
        lighting: 'script.set_theater_dark_delay'

# HBO Max
watch_hbo_max:
  alias: Watch HBO Max
  sequence:
    - service: script.watch_app
      data:
        component: 'com.hbo.hbonow/com.hbo.go.LaunchActivity'
        lighting: 'script.set_theater_dark_delay'

# Hulu
watch_hulu:
  alias: Watch Hulu
  sequence:
    - service: script.watch_app
      data:
        component: 'com.hulu.livingroomplus/.MainActivity'
        lighting: 'script.set_theater_dark_delay'

# Kodi
watch_kodi:
  alias: Watch Kodi
  sequence:
    - service: script.watch_app
      data:
        component: 'org.xbmc.kodi/.Splash'
        lighting: 'script.set_theater_dark_delay'

# Netflix
watch_netflix:
  alias: Watch Netflix
  sequence:
    - service: script.watch_app
      data:
        component: 'com.netflix.ninja/.MainActivity'
        lighting: 'script.set_theater_dark_delay'

# Paramount Plus
watch_paramount_plus:
  alias: Watch Paramount Plus
  sequence:
    - service: script.watch_app
      data:
        component: 'com.cbs.ott/com.cbs.app.tv.ui.activity.SplashActivity'
        lighting: 'script.set_theater_dark_delay'

# Peacock
watch_peacock:
  alias: Watch Peacock
  sequence:
    - service: script.watch_app
      data:
        component: 'com.peacocktv.peacockandroid/com.peacock.peacocktv.GoogleMainActivity'
        lighting: 'script.set_theater_dark_delay'

# Youtube TV
watch_youtube_tv:
  alias: Watch Youtube TV
  sequence:
    - service: script.watch_app
      data:
        component: 'com.google.android.youtube.tvunplugged/com.google.android.apps.youtube.tvunplugged.activity.MainActivity'
        lighting: 'script.set_theater_dark_delay'

#=============================#
#     Harmony Activities      #
#=============================#

# Template script that does the work.
start_activity:
  alias: Start Activity
  fields:
    activity:
      description: 'The Harmony activity name to be started.'
      example: 'BD Player'
    lighting:
      description: 'Script or scene that establishes the desired lighting.'
      example: 'script.set_theater_dark'
  
  sequence:
  
    # Turn on the target activity.
    - service: remote.turn_on
      entity_id: remote.harmony_hub
      data:
        activity: "{{ activity }}"
  
    # Establish the target lighting.
    - service: "{{ lighting }}"

#----------------------#
#   -- Activities --   #
#----------------------#

# Shield TV (streaming)
start_streaming:
  alias: Start Streaming
  sequence:
    - service: script.start_activity
      data:
        activity: 'Stream Player'
        lighting: 'script.set_theater_dark_delay'

# Blu-ray
start_bluray:
  alias: Start Bluray
  sequence:
    - service: script.start_activity
      data:
        activity: 'BD Player'
        lighting: 'script.set_theater_dark_delay'

# Laserdisc
start_laserdisc:
  alias: Start Laserdisc
  sequence:
    - service: script.start_activity
      data:
        activity: 'LD Player'
        lighting: 'script.set_theater_dark_delay'

# Turntable
start_turntable:
  alias: Start Turntable
  sequence:
    - service: script.start_activity
      data:
        activity: 'LP Player'
        lighting: 'script.set_theater_dim'

#========================#
#     Cinema Resume      #
#========================#

# Resume the current harmony activity and restore the lighting.

# Worker script
resume_worker:
  alias: Resume Worker
  fields:
    device:
      description: 'The Harmony device name to be resumed.'
      example: 'Sony DVD/Blu-ray Player'
  
  sequence:
  
    # Send the play command to the target device.
    - service: remote.send_command
      entity_id: remote.harmony_hub
      data:
        command: Play
        device: "{{ device }}"
    
    # Restore theater lighting.
    - service: script.restore_lighting_on_resume

# Call the worker script with the appropriate device based on the Harmony activity.
# Note: The turntable cannot be controlled, so all we do is turn on some lights.
resume_cinema:
  alias: Resume Cinema
  
  sequence:
    - choose:
      - conditions: "{{ is_state('sensor.harmony_hub', 'Stream Player') or is_state('sensor.harmony_hub', 'Enable Streaming') }}"
        
        sequence:
          - service: script.resume_worker
            data:
              device: 'NVIDIA Shield TV'
      
      - conditions: "{{ is_state('sensor.harmony_hub', 'BD Player') }}"
        
        sequence:
          - service: script.resume_worker
            data:
              device: 'Sony DVD/Blu-ray Player'
      
      - conditions: "{{ is_state('sensor.harmony_hub', 'LD Player') }}"
        
        sequence:
          - service: script.resume_worker
            data:
              device: 'Panasonic Laserdisc Player'
      
      - conditions: "{{ is_state('sensor.harmony_hub', 'LP Player') }}"
        
        sequence:
          - service: script.turn_on
            entity_id: script.set_theater_dim
      
      default:
        - service: system_log.write
          data:
            message: Current activity does not support resume command.
            level: warning

# Restore the theater lighting on resume (called by the restore automation and script).
restore_lighting_on_resume:
  alias: Restore Lighting On Resume
  
  sequence:
  
    # Establish 'dark' theater lighting.
    - service: script.turn_on
      entity_id: script.set_theater_dark
    
    # Turn off some downstairs lights.
    - service: script.change_downstairs_lighting
      data:
        turn_on: false
        christmas: false

#============================#
#     Kodi Movie Control     #
#============================#

# Get the list of all movies known by Kodi.
# This script is only needed when the Kodi movie library is updated, and the Shield TV is off (we don't want
# to randomly switch apps if the media player is in use).
get_all_kodi_movies:
  alias: Get All Kodi Movies
  sequence:
    - condition: state
      entity_id: media_player.shield_tv
      state: 'off'
  
    # Turn on the Shield TV so we can host the Kodi application.
    - service: media_player.turn_on
      data:
        entity_id: media_player.shield_tv
    - delay: '00:00:03'
  
    # Start Kodi on the Shield TV.
    - service: androidtv.adb_command
      data:
        entity_id: media_player.shield_tv
        command: "am start -a android.intent.action.MAIN -c android.intent.category.LEANBACK_LAUNCHER -n 'org.xbmc.kodi/.Splash'"
    - delay: '00:00:02'
  
    # Send the 'get movies' command to Kodi.
    - service: kodi.call_method
      data:
        entity_id: media_player.kodi
        method: VideoLibrary.GetMovies
    
    # Wait a bit for a good 'get movies' result, but quit if it times out.
    - wait_for_trigger:
        - platform: event
          event_type: kodi_call_method_result
          event_data:
            result_ok: 'True'
            input:
              method: VideoLibrary.GetMovies
      timeout: 10
      continue_on_timeout: false
    
    # Call the python script to populate the input select.
    - service: pyscript.populate_all_movies
      data:
        entity: input_select.kodi_movies
        result: "{{ trigger.event.data.result }}"
  
    # Exit the Kodi application.
    - service: remote.send_command
      entity_id: remote.harmony_hub
      data:
        command: 'Home'
        device: NVIDIA Shield TV
    - delay: '00:00:02'
    
    # Turn off the Kodi media player.
    - service: media_player.turn_off
      data:
        entity_id: media_player.kodi
  
    # Turn the Shield TV off again.
    - service: media_player.turn_off
      data:
        entity_id: media_player.shield_tv

#===========================#
#     Kodi Play Feature     #
#===========================#

# Play feature movie! 
play_feature_movie:
  alias: Play Feature Movie
  sequence:
    
    # Turn on some lights.
    - service: script.set_theater_idle
  
    # Start the 'enable streaming' Harmony activity, which ensures the correct devices are on and the screen is dark.
    - service: switch.turn_on
      entity_id: switch.harmony_hub_enable_streaming
    - delay: '00:00:03'
  
    # Start Kodi on the Shield TV.
    - service: androidtv.adb_command
      data:
        entity_id: media_player.shield_tv
        command: "am start -a android.intent.action.MAIN -c android.intent.category.LEANBACK_LAUNCHER -n 'org.xbmc.kodi/.Splash'"
    - delay: '00:00:02'
  
    # Send the 'get movies' command to Kodi, with the target movie name.
    - service: kodi.call_method
      data:
        entity_id: media_player.kodi
        method: VideoLibrary.GetMovies
        filter:
          field: title
          operator: is
          value: "{{ states('input_select.kodi_movies') }}"
        limits:
          end: 1
          start: 0
    
    # Wait a bit for a good 'get movies' result, but quit if it times out.
    - wait_for_trigger:
        - platform: event
          event_type: kodi_call_method_result
          event_data:
            result_ok: 'True'
            input:
              method: VideoLibrary.GetMovies
      timeout: 10
      continue_on_timeout: false
    
    # Pick up the movie ID.
    - variables:
        movieid: "{{ trigger.event.data.result.movies.0.movieid }}"
  
    # Now switch the receiver to the proper input so Kodi can be viewed on screen.
    - service: remote.send_command
      entity_id: remote.harmony_hub
      data:
        command: 'InputCbl/Sat'
        device: Marantz Receiver
  
    # Tell Kodi to play the feature.
    - service: kodi.call_method
      data_template:
        entity_id: media_player.kodi
        method: Player.Open
        item:
          movieid: "{{ movieid }}"
  
    # Darken the theater.
    - service: script.turn_on
      entity_id: script.set_theater_dark_delay
