#===============#
#     House     #
#===============#

# Turn off extended away mode if Jon returns home early.
turn_off_extended_away_mode:
  alias: Turn Off Extended Away Mode  
  sequence:

    # Continue only if extended away mode is currently on.  
    - condition: state
      entity_id: input_boolean.extended_away_mode
      state: 'on'
    
    # Set the extended away end 2 minutes from now (the extra time is just to make sure the timing satifies my paranoia).
    # This in turn will trigger the Disable Extended Away Mode automation.
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.extended_away_end
      data:
        datetime: "{{ (now() + timedelta(minutes = 2)).strftime('%Y-%m-%d %H:%M:%S') }}"

#==========================#
#     Computer Control     #
#==========================#

# Lock the PC
lock_pc:
  alias: Lock PC
  sequence:
  
  - service: mqtt.publish
    data:
      topic: "iotlink/workgroup/legion-t530/commands/lock"
      payload: ""

# Turn off the PC
turn_off_pc:
  alias: Turn Off PC
  sequence:
  
  - service: mqtt.publish
    data:
      topic: "iotlink/workgroup/legion-t530/commands/shutdown"
      payload: ""

#=======================#
#     Fire TV Stick     #
#=======================#

# Restart Fire TV stick.
restart_fire_tv:
  alias: Restart Fire TV
  sequence:
    
    - service: switch.turn_off
      entity_id: switch.fire_tv
    
    - delay: '00:00:05'
    
    - service: switch.turn_on
      entity_id: switch.fire_tv

#===================#
#     Shield TV     #
#===================#

# Restart Shield TV.
restart_shield_tv:
  alias: Restart Shield TV
  sequence:
    
    - service: switch.turn_off
      entity_id: switch.shield_tv
    
    - delay: '00:00:05'
    
    - service: switch.turn_on
      entity_id: switch.shield_tv

#========================#
#     Family Room AV     #
#========================#

# Turn on family room AV.
enable_family_room_av:
  alias: Enable Family Room AV
  sequence:
    
    - service: switch.turn_on
      entity_id: switch.fire_tv
    
    - service: switch.turn_on
      entity_id: switch.sonoff_family_room_av

# Turn off family room AV.
disable_family_room_av:
  alias: Disable Family Room AV
  sequence:
    
    - service: switch.turn_off
      entity_id: switch.fire_tv
    
    - service: switch.turn_off
      entity_id: switch.sonoff_family_room_av

#======================#
#     Echo Devices     #
#======================#

# Mute bedroom echo devices until 9 AM the next morning.

mute_guest_bedroom_echo:
  alias: Mute Guest Bedroom Echo
  use_blueprint:
    path: devices/echo_do_not_disturb.yaml
    input:
      switch_entity: switch.guest_bedroom_echo_do_not_disturb_switch
      mute_duration: >
        {% set next = now().today().replace(hour=9, minute=0, second=0, microsecond=0) + timedelta(days = 1) %}
        {{ (next - now().today().replace(microsecond=0)).seconds }}

mute_master_bedroom_echo:
  alias: Mute Master Bedroom Echo
  use_blueprint:
    path: devices/echo_do_not_disturb.yaml
    input:
      switch_entity: switch.master_bedroom_echo_do_not_disturb_switch
      mute_duration: >
        {% set next = now().today().replace(hour=9, minute=0, second=0, microsecond=0) + timedelta(days = 1) %}
        {{ (next - now().today().replace(microsecond=0)).seconds }}

mute_upstairs_bedroom_echo:
  alias: Mute Upstairs Bedroom Echo
  use_blueprint:
    path: devices/echo_do_not_disturb.yaml
    input:
      switch_entity: switch.upstairs_bedroom_echo_do_not_disturb_switch
      mute_duration: >
        {% set next = now().today().replace(hour=9, minute=0, second=0, microsecond=0) + timedelta(days = 1) %}
        {{ (next - now().today().replace(microsecond=0)).seconds }}

#===========================#
#     Garage Door Close     #
#===========================#

# Template script that does the work.
close_garage_door:
  alias: Close Garage Door
  
  # Allow multiple independent runs.
  mode: parallel
  
  fields:
    name:
      description: 'The garage door user friendly name.'
      example: 'my door'
    
    contact:
      description: 'The garage door contact sensor entity.'
      example: 'binary_sensor.shelly1_garage_north_contact'
    
    switch:
      description: 'The switch to operate the garage door.'
      example: 'switch.shelly1_garage_north'
  
  sequence:
  
    # Action is only required if the door is currently open.
    - condition: "{{ is_state(contact, 'off') }}"
    
    # Send an informational notification that the door is about to be closed.
    - service: notify.mobile_app_jon_galaxy
      data:
        title: 'Information:'
        message: "Closing garage door {{ name }}."
        data:
          channel: Security
    
    # Close the door.
    - service: switch.turn_on
      target:
        entity_id: "{{ switch }}"
    
    # Wait for the door to close.
    - delay: '00:05:00'
    
    # Confirm that the door is closed. If so, we're done.
    - condition: "{{ is_state(contact, 'off') }}"
    
    # The door did not close, so send another notification.
    - service: notify.mobile_app_jon_galaxy
      data:
        title: 'Action required:'
        message: "Garage door {{ name }} did not close."
        data:
          channel: Security
          importance: high
          persistent: true
          tag: 'persistent'

#----------------------#
#     Garage Doors     #
#----------------------#

# Garage door north
close_garage_door_north:
  alias: Close Garage Door North
  sequence:
    
    - service: script.close_garage_door
      data:
        name:    'north'
        contact: 'binary_sensor.shelly1_garage_north_contact'
        switch:  'switch.shelly1_garage_north'

# Garage door south
close_garage_door_south:
  alias: Close Garage Door South
  sequence:
    
    - service: script.close_garage_door
      data:
        name:    'south'
        contact: 'binary_sensor.shelly1_garage_south_contact'
        switch:  'switch.shelly1_garage_south'

#============================#
#     Deep Sleep Control     #
#============================#

# Suspend deep sleep on ESPHome devices so we can update the firmware using OTA
suspend_deep_sleep:
  alias: Suspend Deep Sleep
  sequence:
  
  - service: mqtt.publish
    data:
      topic:   porch-sensor/ota_mode
      payload: 'ON'
      retain: true

# Resume deep sleep on ESPHome devices
resume_deep_sleep:
  alias: Resume Deep Sleep
  sequence:
  
  - service: mqtt.publish
    data:
      topic:   porch-sensor/ota_mode
      payload: 'OFF'
  
  - service: mqtt.publish
    data:
      topic:   porch-sensor/ota_mode
      payload: ''
      retain: true

#=====================#
#     Zigbee2MQTT     #
#=====================#

zigbee2mqtt_rename:
  alias: Zigbee2MQTT Rename
  sequence:
    
    - service: mqtt.publish
      data_template:
        topic: zigbee2mqtt/bridge/request/device/rename
        payload_template: >-
          {
            "from": "{{ states.input_text.zigbee2mqtt_old_name.state | string }}",
            "to": "{{ states.input_text.zigbee2mqtt_new_name.state | string }}"
          }

zigbee2mqtt_remove:
  alias: Zigbee2MQTT Remove
  sequence:
    
    - service: mqtt.publish
      data_template:
        topic: zigbee2mqtt/bridge/request/device/remove
        payload_template: >-
          {
            "id": "{{ states.input_text.zigbee2mqtt_remove_name.state | string }}",
            "force": {% if states.input_boolean.zigbee2mqtt_force_remove.state == "off" %}false{% else %}true{% endif %}
          }

#====================#
#     HVAC Vents     #
#====================#

# Template script that does the work.
position_hvac_vent:
  alias: Position HVAC Vent
  
  fields:
    vent:
      description: 'The target vent friendly name.'
      example: 'Upstairs BR Vent 1'
    
    position:
      description: 'The target vent desired position.'
      example: 42
  
  sequence:
    
    - service: mqtt.publish
      data_template:
        topic: "zigbee2mqtt/{{ vent }}/set"
        payload_template: "{\"position\": {{ position }}}"

# Toggle vents.

toggle_upstairs_br_vent:
  alias: Toggle Upstairs BR Vent
  
  fields:
    vent_entity: 
      description: 'The vent entity to be toggled.'
      example: 'cover.upstairs_br_vent_1'
  
  sequence:
    
    - service: system_log.write
      data:
        message: "vent_entity: {{vent_entity}}"
        level: debug
    
    - choose:
      - conditions:
        - condition: template
          value_template: "{{ state_attr(vent_entity, 'current_position') == 0 }}"
        sequence:
          - service: script.position_hvac_vent
            data:
              vent: "{{ state_attr(vent_entity, 'friendly_name') }}"
              position: 100
      
      default:
        - service: script.position_hvac_vent
          data:
            vent: "{{ state_attr(vent_entity, 'friendly_name') }}"
            position: 0

# Open vents to a given percentage (position).

position_upstairs_br_vent_1:
  alias: Position Upstairs BR Vent 1
  sequence:
    
    - service: script.position_hvac_vent
      data:
        vent: "{{ state_attr('cover.upstairs_br_vent_1', 'friendly_name') }}"
        position: "{{ states('input_number.upstairs_bedroom_vent_1_position') }}"

position_upstairs_br_vent_2:
  alias: Position Upstairs BR Vent 2
  sequence:
    
    - service: script.position_hvac_vent
      data:
        vent: "{{ state_attr('cover.upstairs_br_vent_2', 'friendly_name') }}"
        position: "{{ states('input_number.upstairs_bedroom_vent_2_position') }}"

# Convenience scripts to open/close upstairs BR vents.
open_upstairs_br_vents:
  alias: Open Upstairs BR Vents
  sequence:
    
    - service: script.position_hvac_vent
      data:
        vent: 'Upstairs BR Vent 1'
        position: 100
    
    - service: script.position_hvac_vent
      data:
        vent: 'Upstairs BR Vent 2'
        position: 100

close_upstairs_br_vents:
  alias: Close Upstairs BR Vents
  sequence:
    
    - service: script.position_hvac_vent
      data:
        vent: 'Upstairs BR Vent 1'
        position: 0
    
    - service: script.position_hvac_vent
      data:
        vent: 'Upstairs BR Vent 2'
        position: 0

#======================#
#     Ceiling Fans     #
#======================#

set_fan_to_speed:
  alias: Set Fan To Speed
  
  fields:
    entity_id:
      description: 'The target ceiling fan.'
    
    speed:
      description: 'The desired fan speed (0 = off, 33 = low, 66 = medium, 99 = high).'
      example: 66
  
  sequence:
    
    # Set the fan to the specified speed. 
    - service: fan.turn_on
      target:
        entity_id: "{{ entity_id }}"
      data:
        percentage: "{{ speed }}"
    
    # To calculate estimated power consumption, we need to keep track of the specified speed. We do this
    # using a unique input number for each fan. Lovely.
    - choose:
        
      # Family room
      - conditions:
        - condition: template
          value_template: "{{ state_attr(entity_id, 'friendly_name') == 'Family Room Fan' }}"
        
        sequence:
          - service: input_number.set_value
            target:
              entity_id: input_number.family_room_fan_speed
            data:
              value: "{{ speed }}"
        
      # Office
      - conditions:
        - condition: template
          value_template: "{{ state_attr(entity_id, 'friendly_name') == 'Office Fan' }}"
        
        sequence:
          - service: input_number.set_value
            target:
              entity_id: input_number.office_fan_speed
            data:
              value: "{{ speed }}"
        
      # Theater
      - conditions:
        - condition: template
          value_template: "{{ state_attr(entity_id, 'friendly_name') == 'Theater Fan' }}"
        
        sequence:
          - service: input_number.set_value
            target:
              entity_id: input_number.theater_fan_speed
            data:
              value: "{{ speed }}"
      
      # Not a fan we know about, log it.
      default:
        - service: system_log.write
          data:
            message: "Invalid ceiling fan entity {{ state_attr(entity_id, 'friendly_name') }} specified"
            level: error
