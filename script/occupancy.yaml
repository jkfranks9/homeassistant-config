#===============================#
#     Occupied Guest Suites     #
#===============================#

# The guest suites (studio and penthouse) each have a dropdown that identifies the guest(s) using that suite overnight.
# These are maintained here and are driven by the Handle Guest {Arrival|Departure} automations, and also by manual changes
# made that trigger the Modify Occupied Guest Suites automation. Arrivals and departures are likely staggered, and in any 
# case are processed one at a time. Some notes:
#
# - Couples can always stay together, or prefer separate sleeping conditions. 
# - Minors can stay with a parent, or prefer sleeping alone. 
# - Some combinations of guests are valid, while others are not (based on history, preferences, etc).
# - Regardless of the defaults set here, there are some guest combinations that can be changed by the guests themselves.
#   Those are handled by the Modify Occupied Guest Suites automation.

# Add a guest to a suite. This is done for guest arrival, or manually by some guests that can switch suites using a dropdown
# on the dashboard.
add_guest_to_suite:
  alias: Add Guest To Suite
  
  fields:
    guest:
      description: Name of the guest to be added.
    
    suite:
      description: The suite to which the guest is to be added.
      selector:
        select:
          options:
            - Studio
            - Penthouse
  
  sequence:
    - variables:
        suite_entity: "{{ 'input_select.' ~ suite | lower ~ '_guests' }}"
        suite_entry_state: "{{ states(suite_entity) }}"
        conflict: false
        
    # Update the suite guests.
    - choose:
      
      # Some combinations result in a conflict that must be manually resolved.
      - conditions: "{{ guest in ['David', 'Mike'] and suite_entry_state != 'Empty' }}"
        
        sequence:
          - variables:
              conflict: true
      
      - conditions: "{{ guest in ['Sarah', 'Skylar'] and suite_entry_state in ['David', 'Mike'] }}"
        
        sequence:
          - variables:
              conflict: true
      
      # The only valid guest combination is Skylar + Sarah.
      - conditions: "{{ guest in ['Sarah', 'Skylar'] and suite_entry_state != 'Empty' }}"
        
        sequence:
          - action: input_select.select_option
            target:
              entity_id: "{{ suite_entity }}"
            data:
              option: 'Skylar + Sarah'
      
      # Add a valid single guest.
      default:    
        - action: input_select.select_option
          target:
            entity_id: "{{ suite_entity }}"
          data:
            option: "{{ guest }}"
    
    # If we found a conflict, send a notification and quit.
    - if:
        - "{{ conflict == true }}"
      
      then:
        - variables:
            tag: guest_conflict
            title: 'Attention:'
            message: "{{ 'Jon, there is a conflict with adding ' ~ guest ~ ' to the ' ~ suite ~ '.' }}"
            room: ['family_room', 'office']
            channel: standard
            tag_registry_value: "{{ {'tag': tag, 'clear_type': 'manual', 'title': title, 'message': message, 'channel': channel, 'timeout': 0} }}"
            notification_data: "{{ {'destination': ['mobile', 'voice_assistant'], 'room': room, 'voice_type': 'announce', 'title': title, 'message': message, 'channel': channel, 'timeout': 0, 'tag': tag} }}"
    
        # Register the tag.
        - action: script.register_mobile_notification
          data: "{{ tag_registry_value }}"
        
        # Send a notification.    
        - action: script.send_notification
          data: "{{ notification_data }}"
        
        - stop: 'Guest conflict'
    
    # If the suite was empty upon entry, then wait for the associated binary sensor to change before continuing, as the
    # binary sensor could be used when modifying the suite.
    - if:
        - "{{ suite_entry_state == 'Empty' }}"
      
      then:
        - repeat:
            until: "{{ is_state('binary_sensor.' ~ suite | lower ~ '_occupied', 'on') }}"
            
            sequence:
              - event: unused_event
    
    # Prepare the suite for occupancy.    
    - action: script.modify_{{ suite | lower }}
      data:
        reason: arrival

# Remove a guest from a suite. This is done for guest departure, or manually by some guests that can switch suites using a dropdown
# on the dashboard.
remove_guest_from_suite:
  alias: Remove Guest From Suite
  
  fields:
    guest:
      description: Name of the guest to be removed.
    
    suite:
      description: The suite to which the guest is to be removed.
      selector:
        select:
          options:
            - Studio
            - Penthouse
        
  sequence:
    - variables:
        suite_entity: "{{ 'input_select.' ~ suite | lower ~ '_guests' }}"
        combined_guests: "{{ '+' in states(suite_entity) }}"
    
    # Only continue if the guest is currently in the suite. There are cases where this isn't true.
    - condition: "{{ guest in states(suite_entity) }}"
    
    # Update the suite guests.
    - if:
        - "{{ combined_guests }}"
        
      then:    
        - action: input_select.select_option
          target:
            entity_id: "{{ suite_entity }}"
          data:
            option: "{{ iif(guest == 'Sarah', 'Skylar', 'Sarah') }}"
      
      else:    
        - action: input_select.select_option
          target:
            entity_id: "{{ suite_entity }}"
          data:
            option: 'Empty'

        # Since the suite is now empty, wait for the associated binary sensor to change before continuing, as the
        # binary sensor could be used when modifying the suite.
        - repeat:
            until: "{{ is_state('binary_sensor.' ~ suite | lower ~ '_occupied', 'off') }}"
            
            sequence:
              - event: unused_event
    
    # Clean up the suite if needed.
    - choose:
        - conditions: "{{ suite == 'Penthouse' and not combined_guests }}"
      
          sequence:
            
            # Restore penthouse.   
            - action: script.modify_penthouse
              data:
                reason: departure
        
        - conditions: "{{ suite == 'Studio' and not combined_guests }}"
      
          sequence:
            
            # Restore studio.   
            - action: script.modify_studio
              data:
                reason: departure

# Sometimes when both guest suites are occupied, one or more guests want to switch suites. Doing this by moving one guest at a time
# is tedious and requires waiting for (slow) thermostat changes. This script provides a one button method for switching.
switch_guest_suites:
  alias: Switch Guest Suites
  
  sequence:
    
    # Only proceed if both suites are occupied.
    - condition: template
      value_template: "{{ is_state('binary_sensor.studio_occupied', 'on') and is_state('binary_sensor.penthouse_occupied', 'on') }}"
    
    # Set a flag that modifies certain suite-specific functions when we're switching.
    - action: input_boolean.turn_on
      target:
        entity_id: input_boolean.switch_guest_suites
      
    - variables:
        suite_list: ['Studio', 'Penthouse']
          
        # Current suite guest lists. We need these because we'll be changing the actual dropdowns for suite occupancy as we progress.
        studio_guest_list: >
          {% set curr_studio_guests = states('input_select.studio_guests') %}
          {% set var = namespace(list = []) %}
          {% if '+' in curr_studio_guests %}
            {% set var.list = [curr_studio_guests.split(' + ')[0]] %}
            {% set var.list = var.list + [curr_studio_guests.split(' + ')[1]] %}
          {% else %}
            {% set var.list = [curr_studio_guests] %}
          {% endif %}
          {{ var.list }}
        
        penthouse_guest_list: >
          {% set curr_penthouse_guests = states('input_select.penthouse_guests') %}
          {% set var = namespace(list = []) %}
          {% if '+' in curr_penthouse_guests %}
            {% set var.list = [curr_penthouse_guests.split(' + ')[0]] %}
            {% set var.list = var.list + [curr_penthouse_guests.split(' + ')[1]] %}
          {% else %}
            {% set var.list = [curr_penthouse_guests] %}
          {% endif %}
          {{ var.list }}
    
    # To perform the switch, the following happens for each guest in each suite:
    # 
    # 1) Modify the person-specific suite preference. This causes the Modify Occupied Guest Suites automation to run.
    # 2) The automation calls the Remove Guest From Suite and Add Guest To Suite scripts, which change the suite occupancy.
    # 3) As part of removing and adding, the Modify {Studio | Penthouse} scripts run.
    # 4) Those scripts perform any suite processing needed for switching, with the exception of changing the penthouse thermostat metrics.
    # 5) When finished, the switch_guest_suites_complete event is sent; we need to wait for this event for each guest before handling the next.
    #
    # Finally, the penthouse thermostat is modified for the changed guest.
    
    - repeat:
        for_each: "{{ suite_list }}"
      
        sequence:
          - variables:
              guest_list: "{{ iif(repeat.first, studio_guest_list, penthouse_guest_list) }}"
              new_suite: "{{ iif(repeat.first, 'Penthouse', 'Studio') }}"
        
          # Handle all suite guests.
          - repeat:
              for_each: "{{ guest_list }}"
            
              sequence:
                - variables:
                    guest_suite_preference_entity: "{{ 'input_select.' ~ repeat.item | lower ~ '_guest_suite' }}"
                                
                # Modify the person-specific suite preference.
                - action: input_select.select_option
                  target:
                    entity_id: "{{ guest_suite_preference_entity }}"
                  data:
                    option: "{{ new_suite }}"
              
                # Wait for the event indicating we're all done with this guest.
                - wait_for_trigger:
                    - trigger: event
                      event_type: switch_guest_suites_complete
                  timeout:
                    minutes: 2
    
    # Reset the switch flag.
    - action: input_boolean.turn_off
      target:
        entity_id: input_boolean.switch_guest_suites
    
    # We've deferred setting the penthouse thermostat hold while switching; do it now.
    - action: script.modify_penthouse_thermostat_hold

#==========================#
#     Sleep Start/Stop     #
#==========================#

# Prepare for bedtime.
bedtime:
  alias: Bedtime
  
  fields:
    studio_guests_awake:
      name: Studio Guests Awake
      description: Toggle indicating if any studio guests are still awake.
      selector:
        boolean:
  
  sequence:
    
    # Close garage doors ... run the scripts in parallel because they contain a several minute delay.
    - action: script.turn_on
      target:
        entity_id: script.close_garage_door_north
      data:
        variables:
          use_info_message: true
    
    - action:  script.turn_on
      target:
        entity_id: script.close_garage_door_south
      data:
        variables:
          use_info_message: true
    
    # Lock the PC.
    - action: script.turn_on
      entity_id: script.lock_pc
    
    # Turn off certain plugs. These are plugs that are turned on only when needed.
    - action: switch.turn_off
      target:
        entity_id: "{{ label_entities('off_at_night') }}"
    
    # Turn off theater plugs if the theater is not in use.
    - if:
        - "{{ states('input_boolean.theater_open') == 'off' or states('sensor.harmony_hub') == 'PowerOff' }}"
      
      then:    
        - action: switch.turn_off
          target:
            entity_id: "{{ label_entities('theater_off') }}"
    
    # Turn on nighttime mode.
    - action: input_boolean.turn_on
      entity_id: input_boolean.nighttime

    # Perform tasks if no studio guests are awake.
    - if:
        - "{{ studio_guests_awake == false }}"
      
      then:    
        
        # Turn off the Family Room AV system.
        - action: script.disable_family_room_av
    
        # Turn off voice assistant screens and downstairs fans.
        - action: scene.turn_on
          target:
            entity_id:
              - scene.voice_assistants_off
              - scene.fans_off_downstairs
    
    # Perform tasks if the penthouse is not occupied.
    - if:
        - condition: state
          entity_id: binary_sensor.penthouse_occupied
          state: 'off'
      
      then:
        
        # Turn off upstairs fans.
        - action: scene.turn_on
          target:
            entity_id: scene.fans_off_upstairs
      
    # Establish the proper bedtime environment (lights, thermostats, echo devices).
    - action: script.establish_bedtime_environment
      data:
        studio_guests_awake: "{{ studio_guests_awake }}"
  
# Going to sleep now.
sleeptime:
  alias: Sleeptime
  
  sequence:
    
    # Only works during night time.
    - condition: state
      entity_id: input_boolean.nighttime
      state: 'on'
    
    # Turn on sleeptime mode.
    - action: input_boolean.turn_on
      entity_id: input_boolean.sleeptime
    
    # Verify all devices are charging. If not, the Jon Sleeping sensor won't function properly. I can't send a message to the
    # voice assistant device, because we turn on do not disturb at bedtime. So just leave the master bedroom lamp on as an
    # indication that the devices are not charging. Lame.
    - if:
        - condition: state
          entity_id: binary_sensor.jon_devices_charging
          state: 'on'
      
      then:    
        
        # Turn off the master suite lights.
        - action: light.turn_off
          entity_id: light.master_suite_lights

# Turn on the bathroom light during the night.
turn_on_bathroom_light:
  alias: Turn On Bathroom Light
  
  sequence:
    
    # Only works during night time.
    - condition: state
      entity_id: input_boolean.nighttime
      state: 'on'
    
    # Turn on bathroom flag.
    - action: input_boolean.turn_on
      entity_id: input_boolean.bathroom
    
    # Turn on master bedroom lamp.
    - action: light.turn_on
      target:
        entity_id: light.master_bedroom_lamp
      data:
        color_temp_kelvin: 2700
        brightness_pct: "{{ iif(is_state('input_boolean.sleeptime', 'off'), 100, 20) }}"
    
    # Turn on bath light.
    - action: light.turn_on
      entity_id: light.master_vanity
    
    # Wait a few minutes then turn off the bathroom flag and light.
    - delay: '00:15:00'
    
    - action: input_boolean.turn_off
      entity_id: input_boolean.bathroom
    
    - action: light.turn_off
      entity_id: light.master_vanity

#=============================#
#     Bedtime Environment     #
#=============================#

# Bedtime environment rules (lighting and thermostats) are determined by family members present (adults and children), and by the occupied
# bedrooms.

establish_bedtime_environment:
  alias: Establish Bedtime Environment
  
  fields:
    studio_guests_awake:
      name: Studio Guests Awake
      description: Toggle indicating if any studio guests are still awake.
      selector:
        boolean:
  
  sequence:
    
    # Modify the master suite for bedtime.
    - action: script.turn_on
      target:
        entity_id: script.modify_master_suite
      data:
        variables:
          reason: bedtime
        
    # Modify the studio for bedtime.
    - action: script.turn_on
      target:
        entity_id: script.modify_studio
      data:
        variables:
          reason: bedtime
        
    # Modify the penthouse for bedtime.
    - action: script.turn_on
      target:
        entity_id: script.modify_penthouse
      data:
        variables:
          reason: bedtime
      
    # Wait a bit before turning off lights.
    - delay: '00:00:07'
    
    - variables:
        scene: "{{ iif(studio_guests_awake == false, 'non_bedroom_lights_out', 'studio_guests_awake_lights_out') }}"
        fan_light_entities: >
          {% set var = namespace(lights = ['light.office_fan']) %}
          {% if studio_guests_awake == false %}
            {% set var.lights = var.lights + ['light.family_room_fan'] %}
          {% endif %}
          
          {{ var.lights }}
        
    # Turn off non-bedroom lights, but leave some on if studio guests are still awake. Individual suite lights are
    # handled by the suite-specific scripts directly above.
    - action: scene.turn_on
      target:
        entity_id: "{{ 'scene.' ~ scene }}"
              
    # Fan lights are not included in light groups. They operate in optimistic mode and therefore use a script.
    - action: script.turn_off_fan_lights
      data:
        light_entity: "{{ fan_light_entities }}"

# Reset the bedtime environment in the morning. This is called by the Handle Jon Awake automation.
reset_bedtime_environment:
  alias: Reset Bedtime Environment
  
  sequence:
    
    # Modify the master suite for bedtime.
    - action: script.turn_on
      target:
        entity_id: script.modify_master_suite
      data:
        variables:
          reason: wakeup
        
    # Modify the studio for bedtime.
    - action: script.turn_on
      target:
        entity_id: script.modify_studio
      data:
        variables:
          reason: wakeup
        
    # Modify the penthouse for bedtime.
    - action: script.turn_on
      target:
        entity_id: script.modify_penthouse
      data:
        variables:
          reason: wakeup

#==========================#
#     Suite Management     #
#==========================#

# Perform tasks for the master suite for certain events.
modify_master_suite:
  alias: Modify Master Suite
  
  fields:
    reason:
      description: The event that has occurred.
      selector:
        select:
          options:
            - bedtime
            - wakeup
  
  sequence:
    - variables:
        
        # These allow us to perform tasks for any reason without needing to use if/else or choose.
        open_close_option: "{{ iif(reason == 'bedtime', 'open', 'close') }}"
    
    # Perform tasks for any reason.
        
    # Open or close the HVAC vents.
    - action: script.{{ open_close_option }}_hvac_vents
    
    # Perform tasks for bedtime only.
    - if:
        - "{{ reason == 'bedtime' }}"
          
      then:
    
        # Turn on the master bedroom lamp.
        - action: light.turn_on
          target:
            entity_id: light.master_bedroom_lamp
          data:
            color_temp_kelvin: 2700
            brightness_pct: 100
                    
        # Set up other master lights.
        - action: scene.apply
          data:
            entities:
              light.master_closet: 'off'
              light.master_shower: 'off'
              light.master_vanity: 'on'
    
        # PLACE HOLDER
        # I intend to someday add a ceiling fan to the master bedroom.
        # Fan lights are not included in light groups. They operate in optimistic mode and therefore use a script.
        # - action: script.turn_off_fan_lights
          # data:
            # light_entity: [light.master_bedroom_fan]
    
    # Perform tasks for wakeup only.
    - if:
        - "{{ reason == 'wakeup' }}"
          
      then:
  
        # Turn on master bedroom lamp if needed.
        - action: script.turn_on_lights_per_conditions
          data:
            light_entity: light.master_bedroom_lamp
            lux_entity: sensor.downstairs_sensor_ambient_light
            min_lux_value: "{{ states('input_number.master_suite_ambient_min') | float(0) }}"

        # Turn off the master suite lights when motion is detected downstairs.
        - wait_template: >
            {% set motion = states('binary_sensor.downstairs_motion') %}
            {% set devices = state_attr('binary_sensor.downstairs_motion', 'devices') %}
            {% set master = 'binary_sensor.master_bath_motion_detector_occupancy' in devices %}
            {{ motion == 'on' and master == false }}

        - action: homeassistant.turn_off
          target:
            entity_id: light.master_suite_lights

# Perform tasks for the studio for certain events.
modify_studio:
  alias: Modify Studio
  
  fields:
    reason:
      description: The event that has occurred.
      selector:
        select:
          options:
            - arrival
            - departure
            - bedtime
            - wakeup
  
  sequence:
    - choose:
        
        # Arrival tasks.
        - conditions: "{{ reason == 'arrival' }}"
          
          sequence:
            
            # Turn on the preferred lamp(s) if it's dark.
            - if:
                - condition: state
                  entity_id: binary_sensor.studio_arrival_darkness
                  state: 'on'
              
              then:
                - action: script.operate_preferred_studio_lamps
                  data:
                    operation: 'on'
        
        # Departure tasks.
        - conditions: "{{ reason == 'departure' }}"
          
          sequence:
            
            - if:
                - condition: state
                  entity_id: binary_sensor.studio_occupied
                  state: 'off'
              
              then:
            
                # Turn off studio lights.
                - action: light.turn_off
                  target:
                    entity_id: light.studio_lights
        
                # PLACE HOLDER
                # I intend to someday add a ceiling fan to the studio bedroom.
                # Fan lights are not included in light groups. They operate in optimistic mode and therefore use a script.
                # - action: script.turn_off_fan_lights
                  # data:
                # light_entity: [light.studio_bedroom_fan]
        
        # Bedtime tasks.
        - conditions: "{{ reason == 'bedtime' }}"
          
          sequence:
            - choose:
                
                # Make sure lights are off if the studio is not occupied.
                - conditions: "{{ is_state('binary_sensor.studio_occupied', 'off') }}"
              
                  sequence:
                    - action: light.turn_off
                      entity_id: light.studio_lights
    
                    # PLACE HOLDER
                    # I intend to someday add a ceiling fan to the studio bedroom.
                    # Fan lights are not included in light groups. They operate in optimistic mode and therefore use a script.
                    # - action: script.turn_off_fan_lights
                      # data:
                        # light_entity: [light.studio_bedroom_fan]
                
                # Make sure only the night lights are on if the studio is in use by a child only.
                - conditions: "{{ is_state('input_select.studio_guests', 'Skylar') }}"
              
                  sequence:
                    - action: script.operate_preferred_studio_night_lights
                      data:
                        operation: 'on'
                    
                    - action: light.turn_off
                      target:
                        entity_id: light.studio_minus_night_lights
        
            # Set a temporary temperature hold downstairs if needed.
            - if:
                - condition: state
                  entity_id: binary_sensor.studio_occupied
                  state: 'on'
              
              then:
                - action: script.set_temporary_thermostat_hold
                  data:
                    thermostat_entity: climate.downstairs
                    heat_temp: "{{ states('input_number.downstairs_home_heat_temp') }}"
                    cool_temp: "{{ states('input_number.downstairs_home_cool_temp') }}"
                    days: 1
        
        # Wakeup tasks.
        - conditions: "{{ reason == 'wakeup' }}"
          
          sequence:
    
            # Remove downstairs thermostat hold.
            - action: script.remove_thermostat_hold
              data:
                thermostat_entity: climate.downstairs
                extended: false
                    
            # Turn off studio lights.
            - action: light.turn_off
              entity_id: light.studio_lights

# Perform tasks for the penthouse for certain events.
# NOTE: If we're switching suites we defer modifying the thermostat until the switch is complete, to avoid modifying it
#       multiple times (in certain cases), and because it takes a bit of time.
modify_penthouse:
  alias: Modify Penthouse
  
  fields:
    reason:
      description: The event that has occurred.
      selector:
        select:
          options:
            - arrival
            - departure
            - bedtime
            - wakeup
  
  sequence:
    - choose:
        
        # Arrival tasks.
        - conditions: "{{ reason == 'arrival' }}"
          
          sequence:
            
            # Set a temporary thermostat hold if we're not switching suites.
            - if:
                - condition: state
                  entity_id: input_boolean.switch_guest_suites
                  state: 'off'
              
              then:
                - action: script.set_penthouse_thermostat_hold
                    
            # Turn off the vacuum automation.
            - action: script.toggle_vacuum_automation
              data:
                operation: 'off'
            
            # Turn on the penthouse lamp if it's dark.
            - if:
                - condition: state
                  entity_id: binary_sensor.penthouse_arrival_darkness
                  state: 'on'
              
              then:
                - action: light.turn_on
                  target:
                    entity_id: light.penthouse_bed_lamp
        
        # Departure tasks.
        - conditions: "{{ reason == 'departure' }}"
          
          sequence:
            
            # Restore the penthouse to normal if it's unoccupied, and we're not switching suites.
            - if:
                - condition: state
                  entity_id: binary_sensor.penthouse_occupied
                  state: 'off'
                
                - condition: state
                  entity_id: input_boolean.switch_guest_suites
                  state: 'off'
              
              then:
    
                # Remove thermostat hold.
                - action: script.remove_thermostat_hold
                  data:
                    thermostat_entity: climate.upstairs
                    extended: false
                        
                # Turn on the vacuum automation.
                - action: script.toggle_vacuum_automation
                  data:
                    operation: 'on'
                
                # Turn off upstairs lights.
                - action: light.turn_off
                  target:
                    entity_id: light.upstairs_lights
                                  
                # Fan lights are not included in light groups. They operate in optimistic mode and therefore use a script.
                - action: script.turn_off_fan_lights
                  data:
                    light_entity: [light.theater_fan]
        
        # Bedtime tasks.
        - conditions: "{{ reason == 'bedtime' }}"
          
          sequence:
            - choose:
                
                # Turn off all upstairs lights if the penthouse is not occupied.
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.penthouse_occupied
                      state: 'off'
              
                  sequence:
                    - action: light.turn_off
                      entity_id: light.upstairs_lights

                    # Fan lights are not included in light groups. They operate in optimistic mode and therefore use a script.
                    - action: script.turn_off_fan_lights
                      data:
                        light_entity: [light.theater_fan]
                
                # Set up the penthouse lights if a child is sleeping upstairs.
                - conditions: "{{ 'Skylar' in states('input_select.penthouse_guests') }}"
              
                  sequence:
                    - action: scene.apply
                      data:
                        entities:
                          light.penthouse_vanity:             'on'
                          light.penthouse_minus_night_lights: 'off'
                          light.upstairs_common_lights:       'off'
                          light.theater_lights:               'off'
                          
            # Fan lights are not included in light groups. They operate in optimistic mode and therefore use a script.
            - action: script.turn_off_fan_lights
              data:
                light_entity: [light.theater_fan]
        
        # Wakeup tasks.
        - conditions: "{{ reason == 'wakeup' }}"
          
          sequence:
    
            # Turn off the upstairs night light if we turned it on at bedtime.
            # The downstairs night lights (aka daytime lights) are turned off by an automation.
            # Note that if it's still dark, we don't check this light again anywhere. Oh well.
            - if:
                - "{{ 'Skylar' in states('input_select.penthouse_guests') }}"
              
              then:    
                - action: light.turn_off
                  target:
                    entity_id: light.penthouse_vanity

# Set a thermostat hold for the penthouse, that uses a unique temperature range for each family member.
set_penthouse_thermostat_hold:
  alias: Set Penthouse Thermostat Hold
  
  sequence:
    - variables:
        suite_guest: "{{ states('input_select.penthouse_guests') }}"
        guest: "{{ iif('+' in states('input_select.penthouse_guests'), 'Sarah', suite_guest) }}"
        
        # These are temperatures ranges for each guest, that they can change at any time using the dashboard.
        heat_temp_entity: "{{ 'input_number.' ~ guest | lower ~ '_heat_temp' }}"
        cool_temp_entity: "{{ 'input_number.' ~ guest | lower ~ '_cool_temp' }}"

    - action: script.set_temporary_thermostat_hold
      data:
        thermostat_entity: climate.upstairs
        heat_temp: "{{ states(heat_temp_entity) }}"
        cool_temp: "{{ states(cool_temp_entity) }}"
        days: "{{ states('input_number.penthouse_nights_occupied') }}"

# Modify a thermostat hold for the penthouse. This is called when a guest changes the number of nights occupied, or the low/high temperature
# values, and at the completion of switching suites.
modify_penthouse_thermostat_hold:
  alias: Modify Penthouse Thermostat Hold
  
  sequence:
    
    # First, remove the current thermostat hold.
    - action: script.remove_thermostat_hold
      data:
        thermostat_entity: climate.upstairs
        extended: false
    
    # Wait a few minutes before reinstating the new hold: I don't want quick changes to the thermostat settings. The timer expiration
    # automation sets the new hold using the changed information.
    # 
    # Note that the timer could possibly expire while HA is restarting, so set a flag so we can handle that case when HA starts up.
    - action: timer.start
      data:
        entity_id: timer.thermostat_hold_delay
        duration:
          minutes: "{{ states('input_number.thermostat_hold_delay_minutes') }}"
        
    - action: input_boolean.turn_on
      target:
        entity_id: input_boolean.thermostat_hold_delay_timer_started
