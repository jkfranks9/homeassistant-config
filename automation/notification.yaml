#===================================#
#     Maintenance Notifications     #
#===================================#

# Projector lamp is getting old.
- alias: Notify Projector Lamp Aging
  id: 'notify_projector_lamp_aging'
  
  use_blueprint:
    path: notification/maint_above_notify.yaml
    input:
      sensor_entity: sensor.epson_lamp_hours
      threshold: 1999
      timer_entity: timer.projector_lamp_notification
      message: 'Epson projector lamp might need replacing soon.'
      persistent: true
      tag: 'projector_lamp'

# Clear persistent notification.
- alias: Clear Projector Lamp Notification
  id: 'clear_projector_lamp_notification'
  
  trigger:
    - platform: numeric_state
      entity_id: sensor.epson_lamp_hours
      below: 1999
  
  action:
    - service: notify.mobile_app_jon_companion
      data:
        message: 'clear_notification'
        data:
          tag: 'projector_lamp'

# Printer toner is getting low.
- alias: Notify Printer Toner Low
  id: 'notify_printer_toner_low'
  
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor_entity: sensor.brother_printer_black_toner_remaining
      threshold: 10
      timer_entity: timer.printer_toner_notification
      message: 'Printer toner might need replacing soon.'
      persistent: true
      tag: 'printer_toner'

# Clear persistent notification.
- alias: Clear Printer Toner Notification
  id: 'clear_printer_toner_notification'
  
  trigger:
    - platform: numeric_state
      entity_id: sensor.brother_printer_black_toner_remaining
      above: 10
  
  action:
    - service: notify.mobile_app_jon_companion
      data:
        message: 'clear_notification'
        data:
          tag: 'printer_toner'

# Pool needs chlorine tabs.
- alias: Notify Pool Needs Chlorine
  id: 'notify_pool_needs_chlorine'
  
  # Trigger if the high/low temperatures in the next 3 days forecast are below 55 degrees. Below this the salt
  # generator stops producing chlorine, so we need to add tabs.
  #
  # Note that the template below is tricky. The idea is to skip the first day of the forecast, because that's today.
  # Then bump the count if both temps are below the minimum for the next 3 days. However, due to Jinja scoping rules, 
  # a simple scalar value for the count doesn't work. So we start with an empty array, then add items to the array 
  # for each day that has low temps. Finally, compare the number of items in the array. Kludge alert!
  trigger:
    - platform: template
      value_template: >
        {% set forecast = state_attr('weather.openweathermap', 'forecast') %}
        {% set num_cold_days = namespace(count = []) %}
        {% if forecast != None %}
        
          {% for fc in forecast %}
            {% if loop.index0 > 0 and loop.index0 < 4 %}
              {% if fc.temperature < 55 and fc.templow < 55 %}
                {% set num_cold_days.count = num_cold_days.count + [1] %}
              {% endif %}
            {% endif %}            
          {% endfor %}
        {% endif %}
        
        {{ (num_cold_days.count) | length == 3 }}
  
  action:    
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Action required:'
        message: 'Pool might need chlorine tablets.'
        channel: standard
        throttled: false
        tag: ''
        timeout: 0

# F150 service is due.
- alias: Notify F150 Service Due
  id: 'notify_f150_service_due'
  
  use_blueprint:
    path: notification/maint_above_notify.yaml
    input:
      sensor_entity: input_number.f150_mileage
      threshold: input_number.f150_service_due
      timer_entity: timer.f150_service_notification
      message: 'F150 service is due.'
      persistent: true
      tag: 'f150_service'

# Clear persistent notification.
- alias: Clear F150 Service Notification
  id: 'clear_f150_service_notification'
  
  trigger:
    - platform: numeric_state
      entity_id: input_number.f150_service_due
      above: input_number.f150_mileage
  
  action:
    - service: notify.mobile_app_jon_companion
      data:
        message: 'clear_notification'
        data:
          tag: 'f150_service'

# Treadmill lubrication is due.
- alias: Notify Treadmill Lube Due
  id: 'notify_treadmill_lube_due'
  
  use_blueprint:
    path: notification/maint_above_notify.yaml
    input:
      sensor_entity: sensor.treadmill_current_hours
      threshold: input_number.treadmill_lube_due
      timer_entity: timer.treadmill_lube_notification
      message: 'Treadmill lubrication is due.'
      persistent: true
      tag: 'treadmill_lube'

# Clear persistent notification.
- alias: Clear Treadmill Lube Notification
  id: 'clear_treadmill_lube_notification'
  
  trigger:
    - platform: numeric_state
      entity_id: input_number.treadmill_lube_due
      above: sensor.treadmill_current_hours
  
  action:
    - service: notify.mobile_app_jon_companion
      data:
        message: 'clear_notification'
        data:
          tag: 'treadmill_lube'

#==========================================#
#     Abnormal Condition Notifications     #
#==========================================#

# Vacuum did not run.
- alias: Notify Vacuum Lazy
  id: 'notify_vacuum_lazy'
  
  trigger:
    - platform: time
      at: '07:00:00'
  
  condition:
    - condition: time
      weekday:
        - mon
  
  action:
    - condition: state
      entity_id: input_boolean.vacuum_kicked_off
      state: 'off'
    
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Action required:'
        message: 'Vacuum did not run on time.'
        channel: standard
        throttled: false
        tag: ''
        timeout: 0

# Vacuum probably stuck.
- alias: Notify Vacuum Stuck
  id: 'notify_vacuum_stuck'
  
  trigger:
    - platform: time
      at: '07:01:00'
  
  condition:
    - condition: time
      weekday:
        - mon
  
  action:
    - condition: numeric_state
      entity_id: sensor.ecovacs_battery
      below: 90
    
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Action required:'
        message: 'Vacuum appears to be stuck (or not charging).'
        channel: standard
        throttled: false
        tag: ''
        timeout: 0

# Vacuum needs maintenance.
- alias: Notify Vacuum Needs Maintenance
  id: 'notify_vacuum_needs_maintenance'
  
  trigger:
    - platform: event
      event_type: system_log_event
      event_data:
        source: 'sleekxmppfs.basexmpp'
        level: 'ERROR'
  
  condition: "{{ 'error' in trigger.event.data.message }}"
  
  action:    
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Action required:'
        message: 'Vacuum needs maintenance.'
        channel: standard
        throttled: false
        tag: ''
        timeout: 0

#===============================#
#     Battery Notifications     #
#===============================#

# Phone battery is too low.
- alias: Notify Phone Battery Low
  id: 'notify_phone_battery_low'
  
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor_entity: sensor.jon_galaxy_battery_level
      threshold: 15
      timer_entity: timer.phone_battery_notification
      message: 'Phone needs recharging.'
      persistent: true
      tag: 'phone_battery'

# Clear persistent notification.
- alias: Clear Phone Battery Notification
  id: 'clear_phone_battery_notification'
  
  trigger:
    - platform: numeric_state
      entity_id: sensor.jon_galaxy_battery_level
      above: 50
  
  action:
    - service: notify.mobile_app_jon_companion
      data:
        message: 'clear_notification'
        data:
          tag: 'phone_battery'

# Tablet battery is too low.
- alias: Notify Tablet Battery Low
  id: 'notify_tablet_battery_low'
  
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor_entity: sensor.lenovo_tablet_battery_level
      threshold: 15
      timer_entity: timer.tablet_battery_notification
      message: 'Tablet needs recharging.'
      persistent: true
      tag: 'tablet_battery'

# Clear persistent notification.
- alias: Clear Tablet Battery Notification
  id: 'clear_tablet_battery_notification'
  
  trigger:
    - platform: numeric_state
      entity_id: sensor.lenovo_tablet_battery_level
      above: 50
  
  action:
    - service: notify.mobile_app_jon_companion
      data:
        message: 'clear_notification'
        data:
          tag: 'tablet_battery'

# Guest bath motion detector battery is too low.
- alias: Notify Guest Bath Motion Battery Low
  id: 'notify_guest_bath_motion_battery_low'
  
  use_blueprint:
    path: notification/maint_binary_notify.yaml
    input:
      sensor_entity: binary_sensor.guest_bath_motion_detector_battery_low
      timer_entity: timer.guest_bath_motion_detector_battery_notification
      message: 'Guest bath motion detector battery needs replacing.'
      persistent: true
      tag: 'guest_bath_motion_battery'

# Clear persistent notification.
- alias: Clear Guest Bath Motion Battery Notification
  id: 'clear_guest_bath_motion_battery_notification'
  
  trigger:
    - platform: state
      entity_id: binary_sensor.guest_bath_motion_detector_battery_low
      from: 'on'
      to: 'off'
  
  action:
    - service: notify.mobile_app_jon_companion
      data:
        message: 'clear_notification'
        data:
          tag: 'guest_bath_motion_battery'

# Laundry room motion detector battery is too low.
- alias: Notify Laundry Room Motion Battery Low
  id: 'notify_laundry_room_motion_battery_low'
  
  use_blueprint:
    path: notification/maint_binary_notify.yaml
    input:
      sensor_entity: binary_sensor.laundry_room_motion_detector_battery_low
      timer_entity: timer.laundry_room_motion_detector_battery_notification
      message: 'Laundry room motion detector battery needs replacing.'
      persistent: true
      tag: 'laundry_room_motion_battery'

# Clear persistent notification.
- alias: Clear Laundry Room Motion Battery Notification
  id: 'clear_laundry_room_motion_battery_notification'
  
  trigger:
    - platform: state
      entity_id: binary_sensor.laundry_room_motion_detector_battery_low
      from: 'on'
      to: 'off'
  
  action:
    - service: notify.mobile_app_jon_companion
      data:
        message: 'clear_notification'
        data:
          tag: 'laundry_room_motion_battery'

# Master bath motion detector battery is too low.
- alias: Notify Master Bath Motion Battery Low
  id: 'notify_master_bath_motion_battery_low'
  
  use_blueprint:
    path: notification/maint_binary_notify.yaml
    input:
      sensor_entity: binary_sensor.master_bath_motion_detector_battery_low
      timer_entity: timer.master_bath_motion_detector_battery_notification
      message: 'Master bath motion detector battery needs replacing.'
      persistent: true
      tag: 'master_bath_motion_battery'

# Clear persistent notification.
- alias: Clear Master Bath Motion Battery Notification
  id: 'clear_master_bath_motion_battery_notification'
  
  trigger:
    - platform: state
      entity_id: binary_sensor.master_bath_motion_detector_battery_low
      from: 'on'
      to: 'off'
  
  action:
    - service: notify.mobile_app_jon_companion
      data:
        message: 'clear_notification'
        data:
          tag: 'master_bath_motion_battery'

# Back door sensor battery is too low.
- alias: Notify Back Door Sensor Battery Low
  id: 'notify_back_door_sensor_battery_low'
  
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor_entity: sensor.back_door_sensor_battery
      threshold: 15
      timer_entity: timer.back_door_sensor_battery_notification
      message: 'Back door sensor battery needs replacing.'
      persistent: false

# Guest BR window sensor battery is too low.
- alias: Notify Guest BR Window Sensor Battery Low
  id: 'notify_guest_br_window_sensor_battery_low'
  
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor_entity: sensor.guest_br_window_sensor_battery
      threshold: 15
      timer_entity: timer.guest_br_window_sensor_battery_notification
      message: 'Guest BR window sensor battery needs replacing.'
      persistent: false

# Dryer vibration sensor battery is too low.
- alias: Notify Dryer Vibration Sensor Battery Low
  id: 'notify_dryer_vibration_sensor_battery_low'
  
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor_entity: sensor.dryer_vibration_sensor_battery
      threshold: 15
      timer_entity: timer.dryer_vibration_sensor_battery_notification
      message: 'Dryer vibration sensor battery needs replacing.'
      persistent: false

# Porch battery powered sensor needs recharging.
- alias: Notify Porch Sensor Battery Low
  id: 'notify_porch_sensor_battery_low'
  
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor_entity: sensor.porch_battery_level
      threshold: 20.0
      timer_entity: timer.porch_battery_notification
      message: 'Porch sensor battery needs recharging.'
      persistent: true
      tag: 'porch_battery'

# Clear persistent notification.
- alias: Clear Porch Sensor Notification
  id: 'clear_porch_sensor_notification'
  
  trigger:
    - platform: numeric_state
      entity_id: sensor.porch_battery_level
      above: 95
  
  action:
    - service: notify.mobile_app_jon_companion
      data:
        message: 'clear_notification'
        data:
          tag: 'porch_battery'

# Master BR Vent 1 batteries are too low.
- alias: Notify Master BR Vent 1 Batteries Low
  id: 'notify_master_br_vent_1_batteries_low'
  
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor_entity: sensor.master_br_vent_1_battery
      threshold: 26
      timer_entity: timer.master_br_vent_1_battery_notification
      message: 'Master BR vent 1 batteries need replacing.'
      persistent: false

# Master BR Vent 2 batteries are too low.
- alias: Notify Master BR Vent 2 Batteries Low
  id: 'notify_master_br_vent_2_batteries_low'
  
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor_entity: sensor.master_br_vent_2_battery
      threshold: 26
      timer_entity: timer.master_br_vent_2_battery_notification
      message: 'Master BR vent 2 batteries need replacing.'
      persistent: false

#===============================#
#     Health Notifications      #
#===============================#

# Send a notification for overdue exercise.
- alias: Notify Exercise Due
  id: 'notify_exercise_due'
  
  # Trigger every day in the morning.
  trigger:
    - platform: time
      at: '08:00:00'
  
  # Continue if the treadmill or exercise were last used more than 3 days ago (72 hours).
  condition:
    - condition: template
      value_template: >
        {% set t_changed = states('sensor.treadmill_last_changed') %}
        {% set w_changed = states('sensor.workout_last_changed') %}
        {% set t_delta = now() - strptime(t_changed, '%Y-%m-%dT%H:%M:%S%z', now()) %}
        {% set w_delta = now() - strptime(w_changed, '%Y-%m-%dT%H:%M:%S%z', now()) %}
        {% set t_hours = (((t_delta.days * 86400) + t_delta.seconds) / 3600) | round(0) %}
        {% set w_hours = (((w_delta.days * 86400) + w_delta.seconds) / 3600) | round(0) %}
        {{ t_hours > 72 and w_hours > 72 }}
  
  action:    
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Attention:'
        message: 'Exercise is overdue.'
        channel: standard
        throttled: true
        timer_entity: timer.exercise_overdue_notification
        tag: ''
        timeout: 0

#=================================#
#     Proximity Notifications     #
#=================================#

- alias: Notify Jon Arriving Soon
  id: 'notify_jon_arriving_soon'
  use_blueprint:
    path: notification/proximity_notify.yaml
    input:
      proximity_entity: proximity.jon_home
      proximity_meters: 12000
      person_name: Jon

- alias: Notify Mike Arriving Soon
  id: 'notify_mike_arriving_soon'
  use_blueprint:
    path: notification/proximity_notify.yaml
    input:
      proximity_entity: proximity.mike_home
      proximity_meters: 12000
      person_name: Mike

- alias: Notify Sarah Arriving Soon
  id: 'notify_sarah_arriving_soon'
  use_blueprint:
    path: notification/proximity_notify.yaml
    input:
      proximity_entity: proximity.sarah_home
      proximity_meters: 12000
      person_name: Sarah

- alias: Notify David Arriving Soon
  id: 'notify_david_arriving_soon'
  use_blueprint:
    path: notification/proximity_notify.yaml
    input:
      proximity_entity: proximity.david_home
      proximity_meters: 12000
      person_name: David

#==========================#
#     Software Updates     #
#==========================#

# HACS update
- alias: Notify HACS Updated
  id: 'notify_hacs_updated'
  
  trigger:
    - platform: state
      entity_id: sensor.hacs
  
  condition:
    - condition: numeric_state
      entity_id: sensor.hacs
      above: 0
  
  action:
    - service: script.send_notification
      data:
        destination:
          - persistent
        title: 'HACS Updated'
        notification_id: 'hacs_update'
        message: |
          {% set num = states('sensor.hacs') %}
          Updates available for {{ num }} HACS repo{% if num | int(0) > 1 %}s{% endif %}:{{"\n"}}
          {% for repo in states.sensor.hacs.attributes.repositories %}{{ repo.name }} ({{ repo.installed_version }} -> {{ repo.available_version }})
          {% endfor %}

#===============================#
#     Maintenance Reminders     #
#===============================#

# CPAP maintenance
- alias: Notify CPAP Reminder
  id: 'notify_cpap_reminder'
  
  use_blueprint:
    path: notification/reminder_notify.yaml
    input:
      trigger_time: '06:00:00'
      date_entities: [
                      'input_datetime.reminder_cpap_filter', 
                      'input_datetime.reminder_cpap_humidifier', 
                      'input_datetime.reminder_cpap_hose', 
                      'input_datetime.reminder_cpap_mask'
                     ]
      message_prefix: CPAP maintenance due      
      tag_prefix: cpap_maintenance_

# Clear persistent notification.
- alias: Clear CPAP Reminder Notification
  id: 'clear_cpap_reminder_notification'
  
  use_blueprint:
    path: notification/reminder_notify_clear.yaml
    input:
      date_entities: [
                      'input_datetime.reminder_cpap_filter', 
                      'input_datetime.reminder_cpap_humidifier', 
                      'input_datetime.reminder_cpap_hose', 
                      'input_datetime.reminder_cpap_mask'
                     ]
      tag_prefix: cpap_maintenance_

# HVAC maintenance
- alias: Notify HVAC Reminder
  id: 'notify_hvac_reminder'
  
  use_blueprint:
    path: notification/reminder_notify.yaml
    input:
      trigger_time: '06:01:00'
      date_entities: [
                      'input_datetime.reminder_hvac_downstairs', 
                      'input_datetime.reminder_hvac_upstairs'
                     ]
      message_prefix: HVAC maintenance due      
      tag_prefix: hvac_maintenance_

# Clear persistent notification.
- alias: Clear HVAC Reminder Notification
  id: 'clear_hvac_reminder_notification'
  
  use_blueprint:
    path: notification/reminder_notify_clear.yaml
    input:
      date_entities: [
                      'input_datetime.reminder_hvac_downstairs', 
                      'input_datetime.reminder_hvac_upstairs'
                     ]
      tag_prefix: hvac_maintenance_

# Miscellaneous maintenance
- alias: Notify Miscellaneous Reminder
  id: 'notify_miscellaneous_reminder'
  
  use_blueprint:
    path: notification/reminder_notify.yaml
    input:
      trigger_time: '06:02:00'
      date_entities: [
                      'input_datetime.reminder_misc_smokedetectors', 
                      'input_datetime.reminder_misc_9vbatteries',
                      'input_datetime.reminder_misc_cleanfridge',
                      'input_datetime.reminder_misc_cleanoven',
                      'input_datetime.reminder_misc_cleanmicrowavefilter',
                      'input_datetime.reminder_misc_cleandishwasher',
                      'input_datetime.reminder_misc_cleanhvacregs',
                      'input_datetime.reminder_misc_rechargeclipper',
                      'input_datetime.reminder_misc_lubegaragedoors',
                      'input_datetime.reminder_misc_britafilter'
                     ]
      message_prefix: Misc maintenance due      
      tag_prefix: misc_maintenance_

# Clear persistent notification.
- alias: Clear Miscellaneous Reminder Notification
  id: 'clear_miscellaneous_reminder_notification'
  
  use_blueprint:
    path: notification/reminder_notify_clear.yaml
    input:
      date_entities: [
                      'input_datetime.reminder_misc_smokedetectors', 
                      'input_datetime.reminder_misc_9vbatteries',
                      'input_datetime.reminder_misc_cleanfridge',
                      'input_datetime.reminder_misc_cleanoven',
                      'input_datetime.reminder_misc_cleanmicrowavefilter',
                      'input_datetime.reminder_misc_cleandishwasher',
                      'input_datetime.reminder_misc_cleanhvacregs',
                      'input_datetime.reminder_misc_rechargeclipper',
                      'input_datetime.reminder_misc_lubegaragedoors',
                      'input_datetime.reminder_misc_britafilter'
                     ]
      tag_prefix: misc_maintenance_

#==========================#
#     Office Reminders     #
#==========================#

# Payment due
- alias: Notify Payment Due Reminder
  id: 'notify_payment_due_reminder'
  
  use_blueprint:
    path: notification/reminder_notify.yaml
    input:
      trigger_time: '06:03:00'
      date_entities: [
                      'input_datetime.reminder_payment_amazon', 
                      'input_datetime.reminder_payment_creditunion', 
                      'input_datetime.reminder_payment_johndeere',
                      'input_datetime.reminder_payment_mortgage', 
                      'input_datetime.reminder_payment_randolph', 
                      'input_datetime.reminder_payment_wellsfargo'
                     ]
      message_prefix: Payment due
      tag_prefix: payment_due_

# Clear persistent notification.
- alias: Clear Payment Reminder Notification
  id: 'clear_payment_reminder_notification'
  
  use_blueprint:
    path: notification/reminder_notify_clear.yaml
    input:
      date_entities: [
                      'input_datetime.reminder_payment_amazon', 
                      'input_datetime.reminder_payment_creditunion', 
                      'input_datetime.reminder_payment_johndeere',
                      'input_datetime.reminder_payment_mortgage', 
                      'input_datetime.reminder_payment_randolph', 
                      'input_datetime.reminder_payment_wellsfargo'
                     ]
      tag_prefix: payment_due_

# Medication reorder
- alias: Notify Medication Reorder Reminder
  id: 'notify_medication_reorder_reminder'
  
  use_blueprint:
    path: notification/reminder_notify.yaml
    input:
      trigger_time: '06:04:00'
      date_entities: [
                      'input_datetime.reminder_medication_eliquis', 
                      'input_datetime.reminder_medication_gabapentin', 
                      'input_datetime.reminder_medication_metoprolol', 
                      'input_datetime.reminder_medication_rosuvastatin', 
                      'input_datetime.reminder_medication_bloodbuilder', 
                      'input_datetime.reminder_medication_methylb12'
                     ]
      message_prefix: Medication due for reorder
      tag_prefix: medication_reorder_

# Clear persistent notification.
- alias: Clear Medication Reminder Notification
  id: 'clear_medication_reminder_notification'
  
  use_blueprint:
    path: notification/reminder_notify_clear.yaml
    input:
      date_entities: [
                      'input_datetime.reminder_medication_eliquis', 
                      'input_datetime.reminder_medication_gabapentin', 
                      'input_datetime.reminder_medication_metoprolol', 
                      'input_datetime.reminder_medication_rosuvastatin', 
                      'input_datetime.reminder_medication_bloodbuilder', 
                      'input_datetime.reminder_medication_methylb12'
                     ]
      tag_prefix: medication_reorder_

#======================================#
#     Weekly Cleaning Notification     #
#======================================#

# Send an email once a week with the following week's cleaning chores.

- alias: Notify Weekly Cleaning
  id: 'notify_weekly_cleaning'
  
  # Trigger once each Sunday afternoon (the weekday is specified in the conditions).
  trigger:
    - platform: time
      at: '16:00:00'
  
  variables:
    
    # This is the list of datetime objects for all the cleaning chores.
    date_entities: [
                    'input_datetime.reminder_cleaning_dining_foyer',
                    'input_datetime.reminder_cleaning_family_room',
                    'input_datetime.reminder_cleaning_guest_bath',
                    'input_datetime.reminder_cleaning_guest_bedroom',
                    'input_datetime.reminder_cleaning_kitchen',
                    'input_datetime.reminder_cleaning_laundry_room',
                    'input_datetime.reminder_cleaning_master_bath',
                    'input_datetime.reminder_cleaning_master_bedroom',
                    'input_datetime.reminder_cleaning_office',
                    'input_datetime.reminder_cleaning_snack_bar',
                    'input_datetime.reminder_cleaning_theater',
                    'input_datetime.reminder_cleaning_upstairs_bath',
                    'input_datetime.reminder_cleaning_upstairs_bedroom',
                    'input_datetime.reminder_cleaning_utility'
                   ]
    
    # This is the list of actionable cleaning chores (those overdue or due within the next week).
    actionable_entities: >
      {% set actionable_list = namespace(list = []) %}
      {% for entity in date_entities %}
        {% if as_timestamp(states(entity), 0) <= as_timestamp(as_datetime(states('sensor.date')) + timedelta(days = 7), 0) %}
          {% set actionable_list.list = actionable_list.list + [entity] %}
        {% endif %}
      {% endfor %}    
      {{ actionable_list.list }}
  
  # Continue if it's Sunday and the list of actionable cleaning chores is not empty.
  condition:
    - condition: time
      weekday:
        - sun
    
    - "{{ actionable_entities | length > 0 }}"
  
  action:
    
    # First, set the input select that we use for the email body (list of friendly names for cleaning chores) to a single null entry.
    - service: input_select.set_options
      target:
        entity_id: input_select.weekly_cleaning_items
      data:
        options: ['']
    
    # Process each actionable chore entity.
    - repeat:
        for_each: "{{ actionable_entities }}"
        
        sequence:
          
          # Add the chore friendly name for the current actionable entity to the input select. Note that we skip the single
          # null item we added above, by checking for an option length of zero.
          - service: input_select.set_options
            target:
              entity_id: input_select.weekly_cleaning_items
            data:
              options: >
                {% set item_list = namespace(list = []) %}
                {% for opt in state_attr('input_select.weekly_cleaning_items', 'options') %}
                  {% set item_list.list = item_list.list + [opt] %}
                  {% if loop.last %}
                    {% set item_date = states(repeat.item).split('-')[-2] ~ '/' ~ states(repeat.item).split('-')[-1] %}
                    {% set item_text = (state_attr(repeat.item, 'friendly_name').split('Reminder Cleaning ')[-1]) ~ ' (' ~ item_date ~ ')' %}
                    {% if opt | length == 0 %}
                      {% set item_list.list = [item_text] %}
                    {% else %}
                      {% set item_list.list = item_list.list + [item_text] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {{ item_list.list }}
    
    # Send the email. The HTML body contains a list of the friendly names, using the input select we created above. The message is unused (we use the HTML instead),
    # but I believe is a required parameter (at least it is using the developer tools Service tab).
    - service: notify.gmail
      data:
        title: Weekly Cleaning Chores
        message: Test
        data:
          html: >
            <p>This week's cleaning chores:</p><ul>
            {% for opt in state_attr('input_select.weekly_cleaning_items', 'options') %}
              <li>{{ opt }}</li>
            {% endfor %}
            </ul>

#================================#
#     Calendar Notifications     #
#================================#

# Notify about an appointment type of calendar event, identified using the tag "(appt)" in the event title.
# I want to see these 4 hours before the event, to allow ample driving time, etc.
- alias: Notify Calendar Appointment
  id: 'notify_calendar_appointment'
  mode: queued
  
  trigger:
    - platform: calendar
      event: start
      entity_id: calendar.calendar
      offset: -04:00:00
  
  condition: "{{ '(appt)' in trigger.calendar_event.summary }}"
  
  action:
    - service: script.send_notification
      data:
        destination:
          - mobile
          - echo
        title: 'Attention:'
        message: >
          {% set timeobj = as_datetime(as_timestamp(trigger.calendar_event.start, now())) | as_local %}
          {% set time = timeobj.strftime('%H:%M') %}
          {{ trigger.calendar_event.summary | replace(' (appt)', '') }} at {{ time }}
        channel: standard
        throttled: false
        media_player_entity: media_player.everywhere
        tag: ''
        timeout: 0

# Notify about a home type of calendar event, identified using the tag "(home)" in the event title.
# These are things like a worker coming to the house, or a live stream to be joined. 15 minutes before the event is good.
- alias: Notify Calendar Home Event
  id: 'notify_calendar_home_event'
  mode: queued
  
  trigger:
    - platform: calendar
      event: start
      entity_id: calendar.calendar
      offset: -00:15:00
  
  condition: "{{ '(home)' in trigger.calendar_event.summary }}"
  
  action:
    - service: script.send_notification
      data:
        destination:
          - mobile
          - echo
        title: 'Attention:'
        message: >
          {% set timeobj = as_datetime(as_timestamp(trigger.calendar_event.start, now())) | as_local %}
          {% set time = timeobj.strftime('%H:%M') %}
          {{ trigger.calendar_event.summary | replace(' (home)', '') }} at {{ time }}
        channel: standard
        throttled: false
        media_player_entity: media_player.everywhere
        tag: ''
        timeout: 0

# Notify about an astronomy type of calendar event, identified using the tag "(astro)" in the event title.
# Processing of these is more complex than the simple appointment and home events above:
#
# - I'm assuming the maximum dark window of 14 hours (about 5 PM to 7 AM), so that's the offset needed for the calendar trigger
# - I'm assuming there will be a maximum of 2 events per day
# - For an event outside the hours of 10 PM to 7 AM, I want a notification 15 minutes prior to the event
# - For an event between 10 PM and 7 AM I want the notification at 10 PM, so I can decide to either stay up or set an alarm
# - Timers need to be set for when the notification should be issued, and the text of the message needs to be saved (up to 2 timers/texts for 2 separate events)
# - The timer expirations are thus additional triggers
- alias: Notify Calendar Astronomy Event
  id: 'notify_calendar_astronomy_event'
  mode: queued
  
  trigger:
    - platform: calendar
      event: start
      entity_id: calendar.calendar
      offset: -14:00:00
      id: event
    
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.calendar_astronomy_notification_1
      id: timer1
    
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.calendar_astronomy_notification_2
      id: timer2
  
  condition: "{{ (trigger.id == 'event' and '(astro)' in trigger.calendar_event.summary) or 'timer' in trigger.id }}"
  
  action:
    - if:
      
        # For the calendar event trigger, save the message text and set a timer to send the notification later.
        - "{{ trigger.id == 'event' }}"
        
      then:
        - variables:
            event_time_string: "{{ as_datetime(as_timestamp(trigger.calendar_event.start, now()) | timestamp_local(now())).strftime('%H:%M') }}"
            event_hour: "{{ event_time_string.split(':')[0] }}"
            text: "{{ trigger.calendar_event.summary | replace(' (astro)', '') }} at {{ event_time_string }}"
        - if:
          
            # Handle an event time outside the hours of 10 PM to 7 AM (meaning 5:00 PM to 9:59 PM).
            - "{{ event_hour | int(0) >= 17 and event_hour | int(0) < 22 }}"
          
          then:
                
            - if:
                - condition: state
                  entity_id: timer.calendar_astronomy_notification_1
                  state: 'idle'
              
              then:
                - service: input_text.set_value
                  target:
                    entity_id: input_text.calendar_astronomy_notification_message_1
                  data:
                    value: "{{ text }}"
                    
                - service: timer.start
                  data:
                    entity_id: timer.calendar_astronomy_notification_1
                    duration: '13:45:00'
              
              else:
                - service: input_text.set_value
                  target:
                    entity_id: input_text.calendar_astronomy_notification_message_2
                  data:
                    value: "{{ text }}"
                    
                - service: timer.start
                  data:
                    entity_id: timer.calendar_astronomy_notification_2
                    duration: '13:45:00'
          
          # Handle an event time between 10 PM and 7 AM.
          else:
            - variables:
                seconds: "{{ as_timestamp(now().replace(hour = 22, minute = 0, second = 0, microsecond = 0)) - as_timestamp(now().replace(microsecond = 0)) }}"
            
            - if:
                - condition: state
                  entity_id: timer.calendar_astronomy_notification_1
                  state: 'idle'
              
              then:
                - service: input_text.set_value
                  target:
                    entity_id: input_text.calendar_astronomy_notification_message_1
                  data:
                    value: "{{ text }}"
                    
                - service: timer.start
                  data:
                    entity_id: timer.calendar_astronomy_notification_1
                    duration: "{{ seconds }}"
              
              else:
                - service: input_text.set_value
                  target:
                    entity_id: input_text.calendar_astronomy_notification_message_2
                  data:
                    value: "{{ text }}"
                  
                - service: timer.start
                  data:
                    entity_id: timer.calendar_astronomy_notification_2
                    duration: "{{ seconds }}"
        
      # For the timer expiration trigger, send the notification.
      else:
        - if:
            - "{{ trigger.id == 'timer1' }}"
          
          then:
            - service: script.send_notification
              data:
                destination:
                  - mobile
                  - echo
                title: 'Attention:'
                message: "{{ states('input_text.calendar_astronomy_notification_message_1') }}"
                channel: temporary
                timeout: 1800
                throttled: false
                media_player_entity: media_player.everywhere
                tag: ''
          
          else:
            - service: script.send_notification
              data:
                destination:
                  - mobile
                  - echo
                title: 'Attention:'
                message: "{{ states('input_text.calendar_astronomy_notification_message_2') }}"
                channel: temporary
                timeout: 1800
                throttled: false
                media_player_entity: media_player.everywhere
                tag: ''

#==============================#
#     Device Notifications     #
#==============================#

# Washer cycle complete
- alias: Notify Washer Done
  id: 'notify_washer_done'
  trigger:
    - platform: state
      entity_id: input_select.washer_state
      from: Rinse Drain
      to: Stop
  action:
    - service: script.send_notification
      data:
        destination:
          - mobile
          - echo
        title: 'Action required:'
        message: 'Washer has finished.'
        channel: standard
        throttled: false
        media_player_entity: media_player.everywhere
        tag: ''
        timeout: 0

# Dryer cycle complete
- alias: Notify Dryer Done
  id: 'notify_dryer_done'
  trigger:
    - platform: state
      entity_id: input_boolean.dryer_running
      from: 'on'
      to: 'off'
  action:
    - service: script.send_notification
      data:
        destination:
          - mobile
          - echo
        title: 'Action required:'
        message: 'Dryer has probably finished.'
        channel: standard
        throttled: false
        media_player_entity: media_player.everywhere
        tag: ''
        timeout: 0

#================#
#     Hockey     #
#================#

# Next Canes game
- alias: Notify Next Canes Game
  id: 'notify_next_canes_game'
  
  trigger:
    - platform: template
      value_template: >
        {% if states.sensor.next_canes_game is defined and states.sensor.next_canes_game.attributes.gameDate is defined %}
          {% set next = as_timestamp(state_attr('sensor.next_canes_game', 'gameDate'), now()) %}
          {% set now =  as_timestamp(now()) %}
          {{ iif((next - now) > 0, (((next - now) / 3600) | round(0)) < 12, false) }}
        {% else %}
          false
        {% endif %}
  
  action:
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Attention:'
        message: >
          {% if states('sensor.canes_game_status') == 'Home' %}
            {{ states('sensor.canes_opponent') }} at Hurricanes, {{ states('sensor.next_canes_game') }}
          {% else %}
            Hurricanes at {{ states('sensor.canes_opponent') }}, {{ states('sensor.next_canes_game') }}
          {% endif %}
        channel: standard
        throttled: false
        tag: ''
        timeout: 0

#=============#
#     ISS     #
#=============#

# Next ISS pass
- alias: Notify Next ISS Pass
  id: 'notify_next_iss_pass'
  
  trigger:
    - platform: state
      entity_id: binary_sensor.international_space_station_iss_10_minute_pass_warning
      from: 'off'
      to: 'on'
  
  condition:
    - condition: template
      value_template: >
        {{ states('sensor.international_space_station_iss_pass_0') | int(0) >= 300 and 
           state_attr('sensor.international_space_station_iss_pass_0', 'max_elevation') | int(0) >= 35 }}
  
  action:
    - service: script.send_notification
      data:
        destination:
          - mobile
          - echo
        title: 'Attention:'
        message: >
          {% set pass = states.sensor.international_space_station_iss_pass_0.entity_id %}
          ISS in 10 minutes: start {{ state_attr(pass, 'start_compass') }}, end {{ state_attr(pass, 'end_compass') }}, max {{ state_attr(pass, 'max_elevation') | float(0) | round(0) }}
        channel: temporary
        timeout: 1800
        throttled: false
        media_player_entity: media_player.everywhere
        tag: ''

#=========================#
#     Mail & Packages     #
#=========================#

# Package(s) delivered.
- alias: Notify Packages Delivered
  id: 'notify_packages_delivered'
  
  trigger:
    - platform: numeric_state
      entity_id: sensor.mail_amazon_packages_delivered
      above: 0
      id: Amazon
    - platform: numeric_state
      entity_id: sensor.mail_fedex_delivered
      above: 0
      id: FedEx
    - platform: numeric_state
      entity_id: sensor.mail_ups_delivered
      above: 0
      id: UPS
    - platform: numeric_state
      entity_id: sensor.mail_usps_delivered
      above: 0
      id: USPS
  
  condition:
    
    # Ignore any change to or from unavailable state.
    - condition: template
      value_template: "{{ trigger.from_state.state != 'unavailable' and trigger.to_state.state != 'unavailable' }}"
  
  action:
    - service: script.send_notification
      data:
        destination:
          - mobile
          - echo
        title: 'Attention:'
        message: >
          {% set num = states(trigger.entity_id) | int(0) %}
          {{ num }} {{ trigger.id }} {{ iif(num == 1, 'package', 'packages') }} delivered.          
        channel: standard
        throttled: false
        media_player_entity: media_player.everywhere
        tag: ''
        timeout: 0

#========================#
#     Zigbee Devices     #
#========================#

- alias: Notify Zigbee Device Unavailable
  id: 'notify_zigbee_device_unavailable'
  mode: queued
  
  trace:
    stored_traces: 20
  
  # Trigger on any state change to the unavailable devices sensor.
  # NOTE: I'm assuming that the device list can't change while the state stays the same. In other words a single device can't
  # become available at the same time another device becomes unavailable.
  trigger:
    - platform: state
      entity_id: sensor.current_zigbee_unavailable_devices
      from:
  
  variables:
    curr_device_list: "{{ state_attr('sensor.current_zigbee_unavailable_devices', 'device_list') }}"
    curr_unavail_devices: "{{ states('sensor.current_zigbee_unavailable_devices') | int(0) }}"
    curr_devices_str: "Device{% if curr_unavail_devices > 1 %}s{% endif %}"
    prev_device_list: "{{ state_attr('sensor.previous_zigbee_unavailable_devices', 'device_list') }}"
    prev_unavail_devices: "{{ states('sensor.previous_zigbee_unavailable_devices') | int(0) }}"
    prev_devices_str: "Device{% if prev_unavail_devices > 1 %}s{% endif %}"
  
  condition:
    
    # Ignore any change to or from unavailable state.
    - condition: template
      value_template: "{{ trigger.from_state.state != 'unavailable' and trigger.to_state.state != 'unavailable' }}"
    
    # Ensure the state matches the number of devices in the list. Just call me paranoid.
    - condition: template
      value_template: "{{ trigger.to_state.state | int(0) == curr_device_list | count }}"
    
    # Ignore spurious nonsense during HA startup.
    - condition: state
      entity_id: input_boolean.zigbee_catch_22
      state: 'off'
  
  action:
    
    # DEBUG messages
    - service: system_log.write
      data:
        message: "From state: {{ trigger.from_state }}"
        level: info    
    - service: system_log.write
      data:
        message: "To state: {{ trigger.to_state }}"
        level: info
    # DEBUG messages
    
    - choose:
      
      # Devices have become unavailable, and none were previously unavailable.
      - conditions: "{{ trigger.from_state.state | int(0) == 0 }}"
      
        sequence:
          
          # Issue the unavailable devices notification.
          - service: script.send_notification
            data:
              destination:
                - persistent
              title: |
                Zigbee {{ curr_devices_str }} Unavailable:
              notification_id: 'zigbee_device_unavail'
              message: |
                {% for device in curr_device_list %}
                  {{ device }}{% if not loop.last %},{% endif %}
                {% endfor %}
          
          # Process all unavailable devices.
          - repeat:
              count: "{{ curr_unavail_devices }}"
              sequence:
          
                - variables:
                    device_name: "{{ curr_device_list[repeat.index - 1] }}"
                    timestamp_entity: "{{ 'input_number.' ~ (device_name | replace(' ', '_') | lower) }}"
                
                # Save the timestamp for the device. This causes the device to be added to the Previous Zigbee Unavailable Devices sensor.
                - service: input_number.set_value
                  target:
                    entity_id: "{{ timestamp_entity }}"
                  data:
                    value: "{{ as_timestamp(now()) }}"
        
      # Devices have become available, and none are still unavailable.
      - conditions: "{{ trigger.to_state.state | int(0) == 0 }}"
      
        sequence:
          
          # Remove the unavailable devices notification.
          - service: persistent_notification.dismiss
            data:
              notification_id: 'zigbee_device_unavail'
          
          # Process all previously unavailable devices.
          - repeat:
              count: "{{ prev_unavail_devices }}"
              sequence:
                
                - variables:
                    device_name: "{{ prev_device_list[repeat.index - 1] }}"
                    timestamp_entity: "{{ 'input_number.' ~ (device_name | replace(' ', '_') | lower) }}"
                    from_time: "{{ states(timestamp_entity) | int(0) | timestamp_custom('%b %d %X') }}"
                    to_time: "{{ as_timestamp(now()) | timestamp_custom('%b %d %X') }}"
                    total_friendly: >
                      {% from 'friendly_strings.jinja' import format_duration %}
                      {{ format_duration(states(timestamp_entity) | float(0)) }}
              
                # Issue the restored device notification.
                - service: script.send_notification
                  data:
                    destination:
                      - persistent
                    title: 'Zigbee Device Restored:'
                    notification_id: "{{ 'zigbee_device_restored_' ~ as_timestamp(now()) | int(0) }}"
                    message: "{{ device_name ~ ' restored: (' ~ from_time ~ ' - ' ~ to_time ~ '), ' ~ total_friendly }}"
              
                # Remove the timestamp for the device.
                - service: input_number.set_value
                  target:
                    entity_id: "{{ timestamp_entity }}"
                  data:
                    value: 0
        
      # Devices have become unavailable, and some were previously unavailable.
      - conditions: "{{ trigger.to_state.state | int(0) > trigger.from_state.state | int(0) }}"
      
        sequence:
          
          # Issue the unavailable devices notification.
          - service: script.send_notification
            data:
              destination:
                - persistent
              title: |
                Zigbee {{ curr_devices_str }} Unavailable:
              notification_id: 'zigbee_device_unavail'
              message: |
                {% for device in curr_device_list %}
                  {{ device }}{% if not loop.last %},{% endif %}
                {% endfor %}
          
          # Process all newly unavailable devices.
          - repeat:
              count: "{{ curr_unavail_devices }}"
              sequence:
                
                - variables:
                    device_name: "{{ curr_device_list[repeat.index - 1] }}"
              
                - if:
                    - "{{ device_name not in prev_device_list }}"
                  
                  then:
                
                    - variables:
                        timestamp_entity: "{{ 'input_number.' ~ (device_name | replace(' ', '_') | lower) }}"
          
                    # Save the timestamp for the device. This causes the device to be added to the Previous Zigbee Unavailable Devices sensor.
                    - service: input_number.set_value
                      target:
                        entity_id: "{{ timestamp_entity }}"
                      data:
                        value: "{{ as_timestamp(now()) }}"
        
      # Devices have become available, and some are still unavailable.
      - conditions: "{{ trigger.to_state.state | int(0) < trigger.from_state.state | int(0) }}"
      
        sequence:
          
          # Issue the unavailable devices notification.
          - service: script.send_notification
            data:
              destination:
                - persistent
              title: |
                Zigbee {{ curr_devices_str }} Unavailable:
              notification_id: 'zigbee_device_unavail'
              message: |
                {% for device in curr_device_list %}
                  {{ device }}{% if not loop.last %},{% endif %}
                {% endfor %}
          
          # Process all newly available devices.
          - repeat:
              count: "{{ prev_unavail_devices }}"
              sequence:
                
                - variables:
                    device_name: "{{ prev_device_list[repeat.index - 1] }}"
                    device_name_id: "{{ device_name | replace(' ', '_') | lower }}"
              
                - if:
                    - "{{ device_name not in curr_device_list }}"
                  
                  then:
                
                    - variables:
                        timestamp_entity: "{{ 'input_number.' ~ device_name_id }}"
                        from_time: "{{ states(timestamp_entity) | int(0) | timestamp_custom('%b %d %X') }}"
                        to_time: "{{ as_timestamp(now()) | timestamp_custom('%b %d %X') }}"
                        total_friendly: >
                          {% from 'friendly_strings.jinja' import format_duration %}
                          {{ format_duration(states(timestamp_entity) | float(0)) }}
          
                    # Issue the restored device notification.
                    - service: script.send_notification
                      data:
                        destination:
                          - persistent
                        title: 'Zigbee Device Restored:'
                        notification_id: "{{ 'zigbee_device_restored_' ~ device_name_id ~ '_' ~ as_timestamp(now()) | int(0) }}"
                        message: "{{ device_name ~ ' restored: (' ~ from_time ~ ' - ' ~ to_time ~ '), ' ~ total_friendly }}"
          
                    # Remove the timestamp for the device.
                    - service: input_number.set_value
                      target:
                        entity_id: "{{ timestamp_entity }}"
                      data:
                        value: 0

#=======================================#
#     Time/Date Based Notifications     #
#=======================================#

# Credit reports should be ordered early in the year.
- alias: Notify Credit Reports Due
  id: 'notify_credit_reports_due'
  
  trigger:
    - platform: state
      entity_id: sensor.credit_reports_due
      from: 'False'
      to: 'True'
  
  action:
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Action required:'
        message: 'Order annual credit reports.'
        channel: standard
        throttled: false
        tag: ''
        timeout: 0

# Budget tracking is due on Sundays.
- alias: Notify Budget Tracking Due
  id: 'notify_budget_tracking_due'
  
  trigger:
    - platform: time
      at: '07:00:00'
  
  condition:
    - condition: time
      weekday:
        - sun
  
  action:
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Action required:'
        message: 'Budget tracking due.'
        channel: standard
        throttled: false
        tag: ''
        timeout: 0

# Various monthly items are due the first of the month.
- alias: Notify Monthly Items Due
  id: 'notify_monthly_items_due'
  
  trigger:
    - platform: state
      entity_id: sensor.first_of_month
      from: 'False'
      to: 'True'
  
  action:
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Action required:'
        message: 'Debt tracking due.'
        channel: standard
        throttled: false
        tag: ''
        timeout: 0
    
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Action required:'
        message: 'Transfer monthly amount from checking to savings.'
        channel: standard
        throttled: false
        tag: ''
        timeout: 0

# Pool cleaning is normally due on Saturdays, but also Wednesdays during peak spring and fall, because of extra blooms and leaves.
- alias: Notify Pool Cleaning Due
  id: 'notify_pool_cleaning_due'
  
  trigger:
    - platform: time
      at: '07:00:00'
  
  condition:
    - or:
      - condition: time
        weekday:
          - sat
      
      - condition: template
        value_template: "{{ now().month in [3, 4, 10, 11] and now().isoweekday() == 3 }}"
  
  action:
    - service: script.send_notification
      data:
        destination:
          - mobile
        title: 'Action required:'
        message: 'Pool cleaning due.'
        channel: standard
        throttled: false
        tag: ''
        timeout: 0
