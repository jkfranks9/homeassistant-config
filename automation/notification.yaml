#===================================#
#     Maintenance Notifications     #
#===================================#

# Projector lamp is getting old.
- alias: Notify Projector Lamp Aging
  id: 'notify_projector_lamp_aging'
  use_blueprint:
    path: notification/maint_above_notify.yaml
    input:
      sensor1_entity: sensor.epson_lamp_hours
      threshold1: 2999
      # Sensor/threshold 2 unused - this can never trigger
      sensor2_entity: sensor.jon_galaxy_battery_level
      threshold2: 100
      timer_entity: timer.projector_lamp_notification
      message: 'Epson projector lamp might need replacing soon.'

# Printer toner is getting low.
- alias: Notify Printer Toner Low
  id: 'notify_printer_toner_low'
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor1_entity: sensor.brother_printer_black_toner_remaining
      threshold1: 10
      # Sensor/threshold 2 unused - this can never trigger
      sensor2_entity: sensor.count_automations
      threshold2: 1
      timer_entity: timer.printer_toner_notification
      message: 'Printer toner might need replacing soon.'

# Vacuum main brush is getting old.
- alias: Notify Vacuum Main Brush Aging
  id: 'notify_vacuum_main_brush_aging'
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor1_entity: sensor.ecovacs_main_brush_remaining_life
      threshold1: 20
      # Sensor/threshold 2 unused - this can never trigger
      sensor2_entity: sensor.count_automations
      threshold2: 1
      timer_entity: timer.vacuum_main_brush_notification
      message: 'Vacuum main brush might need replacing soon.'

# Vacuum side brush is getting old.
- alias: Notify Vacuum Side Brush Aging
  id: 'notify_vacuum_side_brush_aging'
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor1_entity: sensor.ecovacs_side_brush_remaining_life
      threshold1: 20
      # Sensor/threshold 2 unused - this can never trigger
      sensor2_entity: sensor.count_automations
      threshold2: 1
      timer_entity: timer.vacuum_side_brush_notification
      message: 'Vacuum side brush might need replacing soon.'

# Vacuum filter is getting old.
- alias: Notify Vacuum Filter Aging
  id: 'notify_vacuum_filter_aging'
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor1_entity: sensor.ecovacs_filter_remaining_life
      threshold1: 20
      # Sensor/threshold 2 unused - this can never trigger
      sensor2_entity: sensor.count_automations
      threshold2: 1
      timer_entity: timer.vacuum_filter_notification
      message: 'Vacuum filter might need replacing soon.'

#==========================================#
#     Abnormal Condition Notifications     #
#==========================================#

# Vacuum did not run.
- alias: Notify Vacuum Lazy
  id: 'notify_vacuum_lazy'
  trigger:
    - platform: time
      at: '07:00:00'
  condition:
    - condition: time
      weekday:
        - mon
  action:
    - condition: state
      entity_id: input_boolean.vacuum_kicked_off
      state: 'off'
    - service: script.throttle_mobile_notification
      data:
        timer_entity: timer.vacuum_lazy_notification
        title: 'Action required:'
        message: 'Vacuum did not run on time.'
        channel: Home Assistant

# Vacuum probably stuck.
- alias: Notify Vacuum Stuck
  id: 'notify_vacuum_stuck'
  trigger:
    - platform: time
      at: '07:01:00'
  condition:
    - condition: time
      weekday:
        - mon
  action:
    - condition: numeric_state
      entity_id: sensor.ecovacs_battery
      below: 90
    - service: script.throttle_mobile_notification
      data:
        timer_entity: timer.vacuum_stuck_notification
        title: 'Action required:'
        message: 'Vacuum appears to be stuck (or not charging).'
        channel: Home Assistant

# Vacuum needs maintenance.
- alias: Notify Vacuum Needs Maintenance
  id: 'notify_vacuum_needs_maintenance'
  trigger:
    - platform: event
      event_type: system_log_event
      event_data:
        source: 'sleekxmppfs.basexmpp'
        level: 'ERROR'
  condition:
    - condition: template
      value_template: "{{ 'error' in trigger.event.data.message }}"
  action:
    - service: script.throttle_mobile_notification
      data:
        timer_entity: timer.vacuum_needs_maintenance_notification
        title: 'Action required:'
        message: 'Vacuum needs maintenance.'
        channel: Home Assistant

#===============================#
#     Battery Notifications     #
#===============================#

# Phone battery is too low.
- alias: Notify Phone Battery Low
  id: 'notify_phone_battery_low'
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor1_entity: sensor.jon_galaxy_battery_level
      threshold1: 15
      # Sensor/threshold 2 unused - this can never trigger
      sensor2_entity: sensor.count_automations
      threshold2: 1
      timer_entity: timer.phone_battery_notification
      message: 'Phone needs recharging.'

# Tablet battery is too low.
- alias: Notify Tablet Battery Low
  id: 'notify_tablet_battery_low'
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor1_entity: sensor.lenovo_tablet_battery_level
      threshold1: 15
      # Sensor/threshold 2 unused - this can never trigger
      sensor2_entity: sensor.count_automations
      threshold2: 1
      timer_entity: timer.tablet_battery_notification
      message: 'Tablet needs recharging.'

# Guest bath motion detector battery is too low.
- alias: Notify Guest Bath Motion Battery Low
  id: 'notify_guest_bath_motion_battery_low'
  use_blueprint:
    path: notification/maint_binary_notify.yaml
    input:
      sensor_entity: binary_sensor.guest_bath_motion_detector_battery_low
      timer_entity: timer.guest_bath_motion_detector_battery_notification
      message: 'Guest bath motion detector battery needs replacing.'

# Laundry room motion detector battery is too low.
- alias: Notify Laundry Room Motion Battery Low
  id: 'notify_laundry_room_motion_battery_low'
  use_blueprint:
    path: notification/maint_binary_notify.yaml
    input:
      sensor_entity: binary_sensor.laundry_room_motion_detector_battery_low
      timer_entity: timer.laundry_room_motion_detector_battery_notification
      message: 'Laundry room motion detector battery needs replacing.'

# Master bath motion detector battery is too low.
- alias: Notify Master Bath Motion Battery Low
  id: 'notify_master_bath_motion_battery_low'
  use_blueprint:
    path: notification/maint_binary_notify.yaml
    input:
      sensor_entity: binary_sensor.master_bath_motion_detector_battery_low
      timer_entity: timer.master_bath_motion_detector_battery_notification
      message: 'Master bath motion detector battery needs replacing.'

# Porch battery powered sensor needs recharging.
- alias: Notify Porch Sensor Battery Low
  id: 'notify_porch_sensor_battery_low'
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor1_entity: sensor.porch_battery_level
      threshold1: 20.0
      sensor2_entity: sensor.porch_battery_voltage
      threshold2: 3.24
      timer_entity: timer.porch_battery_notification
      message: 'Porch sensor battery needs recharging.'

# Upstairs BR Vent 1 batteries are too low.
- alias: Notify Upstairs BR Vent 1 Batteries Low
  id: 'notify_upstairs_br_vent_1_batteries_low'
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor1_entity: sensor.upstairs_br_vent_1_battery
      threshold1: 15
      # Sensor/threshold 2 unused - this can never trigger
      sensor2_entity: sensor.count_automations
      threshold2: 1
      timer_entity: timer.upstairs_br_vent_1_battery_notification
      message: 'Upstairs BR vent 1 batteries need replacing.'

# Upstairs BR Vent 2 batteries are too low.
- alias: Notify Upstairs BR Vent 2 Batteries Low
  id: 'notify_upstairs_br_vent_2_batteries_low'
  use_blueprint:
    path: notification/maint_below_notify.yaml
    input:
      sensor1_entity: sensor.upstairs_br_vent_2_battery
      threshold1: 15
      # Sensor/threshold 2 unused - this can never trigger
      sensor2_entity: sensor.count_automations
      threshold2: 1
      timer_entity: timer.upstairs_br_vent_2_battery_notification
      message: 'Upstairs BR vent 2 batteries need replacing.'

#===============================#
#     Health Notifications      #
#===============================#

# Send a notification if the UV index or dew point rise above an unhealthy threshold.
- alias: Notify Outdoors Unhealthy
  id: 'notify_outdoors_unhealthy'
  
  trigger:
    
    # UV index rises to unhealthy level
    - platform: numeric_state
      entity_id: sensor.current_uv_index
      above: 7.9999
    
    # Dew point rises to unhealthy level
    - platform: numeric_state
      entity_id: sensor.outdoor_dewpoint
      above: 70.0
    
    # Once in the morning in case the levels are already high
    - platform: time
      at: '07:15:00'
      
    # In case Home Assistant restarts after the morning check just as the level(s) rise above the threshold
    - platform: homeassistant
      event: start
  
  condition:
    - and:
      
        # Only during daytime
        - condition: state
          entity_id: sun.sun
          state: above_horizon
      
        # Only if the levels are high (for the Home Assistant start trigger)
        - or:
          - condition: numeric_state
            entity_id: sensor.current_uv_index
            above: 7.9999
          - condition: numeric_state
            entity_id: sensor.outdoor_dewpoint
            above: 65.0
  
  action:
    - delay: 
        seconds: "{{ range(2, 15) | random }}"
    
    - service: script.throttle_mobile_notification
      data:
        timer_entity: timer.outdoors_unhealthy_notification
        title: 'Warning:'
        message: 'Outdoor quality is unhealthy.'
        channel: Home Assistant

#=================================#
#     Proximity Notifications     #
#=================================#

- alias: Notify Jon Arriving Soon
  id: 'notify_jon_arriving_soon'
  use_blueprint:
    path: notification/proximity_notify.yaml
    input:
      proximity_entity: proximity.jon_home
      proximity_meters: 12000
      person_name: Jon

- alias: Notify Mike Arriving Soon
  id: 'notify_mike_arriving_soon'
  use_blueprint:
    path: notification/proximity_notify.yaml
    input:
      proximity_entity: proximity.mike_home
      proximity_meters: 12000
      person_name: Mike

- alias: Notify Sarah Arriving Soon
  id: 'notify_sarah_arriving_soon'
  use_blueprint:
    path: notification/proximity_notify.yaml
    input:
      proximity_entity: proximity.sarah_home
      proximity_meters: 12000
      person_name: Sarah

#- alias: Notify David Arriving Soon
#  id: 'notify_david_arriving_soon'
#  use_blueprint:
#    path: notification/proximity_notify.yaml
#    input:
#      proximity_entity: proximity.david_home
#      proximity_meters: 12000
#      person_name: David

#==========================#
#     Software Updates     #
#==========================#

# HACS update
- alias: Notify HACS Updated
  id: 'notify_hacs_updated'
  trigger:
    - platform: state
      entity_id: sensor.hacs
    - platform: homeassistant
      event: start
  condition:
    - condition: numeric_state
      entity_id: sensor.hacs
      above: 0
  action:
    - delay:
        seconds: "{{ range(1, 5) | random }}"
    - service: persistent_notification.create
      data_template:
        title: 'HACS Updated'
        notification_id: 'hacs_update'
        message: |
          {% set num = states('sensor.hacs') %}
          Updates available for {{ num }} HACS repo{% if num | int(0) > 1 %}s{% endif %}:{{"\n"}}
          {% for repo in states.sensor.hacs.attributes.repositories %}{{ repo.name }} ({{ repo.installed_version }} -> {{ repo.available_version }})
          {% endfor %}

# Shelly1 firmware update
- alias: Notify Shelly1 North Firmware Updated
  id: 'notify_shelly1_north_firmware_updated'
  trigger:
    - platform: state
      entity_id: binary_sensor.shelly1_garage_north_firmware_update
      from: 'off'
      to: 'on'
    - platform: homeassistant
      event: start
  condition:
    - condition: state
      entity_id: binary_sensor.shelly1_garage_north_firmware_update
      state: 'on'
  action:
    - delay:
        seconds: "{{ range(1, 5) | random }}"
    - service: persistent_notification.create
      data_template:
        title: 'Shelly1 North Firmware Updated'
        notification_id: 'shelly1_north_update'
        message: |
          New version is {{ state_attr('binary_sensor.shelly1_garage_north_firmware_update', 'latest_stable_version') }}, currently on {{ state_attr('binary_sensor.shelly1_garage_north_firmware_update', 'installed_version') }}

- alias: Notify Shelly1 South Firmware Updated
  id: 'notify_shelly1_south_firmware_updated'
  trigger:
    - platform: state
      entity_id: binary_sensor.shelly1_garage_south_firmware_update
      from: 'off'
      to: 'on'
    - platform: homeassistant
      event: start
  condition:
    - condition: state
      entity_id: binary_sensor.shelly1_garage_south_firmware_update
      state: 'on'
  action:
    - delay:
        seconds: "{{ range(1, 5) | random }}"
    - service: persistent_notification.create
      data_template:
        title: 'Shelly1 South Firmware Updated'
        notification_id: 'shelly1_south_update'
        message: |
          New version is {{ state_attr('binary_sensor.shelly1_garage_south_firmware_update', 'latest_stable_version') }}, currently on {{ state_attr('binary_sensor.shelly1_garage_south_firmware_update', 'installed_version') }}

#===================#
#     Reminders     #
#===================#

# CPAP maintenance
- alias: Notify CPAP Reminder
  id: 'notify_cpap_reminder'
  trigger:
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_cpap_filter'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: filter
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_cpap_headgear_humidifier'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: headgear
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_cpap_hose'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: hose
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_cpap_mask'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: mask
  action:
    - service: script.throttle_mobile_notification
      data:
        timer_entity: timer.cpap_reminder_notification
        title: 'Action required:'
        message: 'CPAP maintenance due ({{ trigger.id }}).'
        channel: Home Assistant

# HVAC maintenance
- alias: Notify HVAC Reminder
  id: 'notify_hvac_reminder'
  trigger:
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_hvac_filters_downstairs'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: downstairs
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_hvac_filters_upstairs'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: upstairs
  action:
    - service: script.throttle_mobile_notification
      data:
        timer_entity: timer.hvac_reminder_notification
        title: 'Action required:'
        message: 'HVAC maintenance due ({{ trigger.id }}).'
        channel: Home Assistant

# Payment due
- alias: Notify Payment Due Reminder
  id: 'notify_payment_due_reminder'
  trigger:
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_payment_amazon'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: Amazon
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_payment_credit_union'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: CU
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_payment_mortgage'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: mortgage
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_payment_randolph'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: Randolph
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_payment_wells_fargo'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: WF
  action:
    - service: script.throttle_mobile_notification
      data:
        timer_entity: timer.payment_reminder_notification
        title: 'Action required:'
        message: 'Payment due ({{ trigger.id }}).'
        channel: Home Assistant

# Medication reorder
- alias: Notify Medication Reorder Reminder
  id: 'notify_medication_reorder_reminder'
  trigger:
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_medication_eliquis'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: Eliquis
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_medication_gabapentin'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: gabapentin
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_medication_metoprolol'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: metoprolol
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_medication_rosuvastatin'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: rosuvastatin
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_medication_blood_builder_minis'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: blood builder
    - platform: template
      value_template: >
        {% set entity_date = as_local(now().fromtimestamp(as_timestamp(states('input_datetime.reminder_medication_methyl_b12'), 0))).replace(hour=6) %}
        {% set now_date = as_local(now().fromtimestamp(as_timestamp(states('sensor.date'), 0))).replace(hour=6) %}
        {{ entity_date <= now_date }}
      id: B12
  action:
    - service: script.throttle_mobile_notification
      data:
        timer_entity: timer.medication_reminder_notification
        title: 'Action required:'
        message: 'Medication due for reorder ({{ trigger.id }}).'
        channel: Home Assistant

#================================#
#     Calendar Notifications     #
#================================#

# Appointment
- alias: Notify Appointment
  id: 'notify_appointment'
  trigger:
    - platform: state
      entity_id: calendar.appointments
      attribute: offset_reached
      from: false
      to: true
  action:
    - service: notify.mobile_app_jon_galaxy
      data:
        title: 'Reminder:'
        message: >
          {% set timeobj = strptime(state_attr('calendar.appointments', 'start_time'), '%Y-%m-%d %H:%M:%S') %}
          {% set time = timeobj.strftime('%H:%M') %}
          {{ state_attr('calendar.appointments', 'message') }} tomorrow at {{ time }}
        data:
          channel: Home Assistant

#==============================#
#     Device Notifications     #
#==============================#

# Washer cycle complete
- alias: Notify Washer Done
  id: 'notify_washer_done'
  trigger:
    - platform: state
      entity_id: input_select.washer_state
      from: Rinse Drain
      to: Stop
  action:
    - service: notify.mobile_app_jon_galaxy
      data:
        title: 'Action required:'
        message: 'Washer has finished.'
        data:
          channel: Home Assistant
    - service: notify.alexa_media
      data:
        target:
          - media_player.everywhere
        data:
          type: announce
        message: 'Washer has finished.'

# Dryer cycle complete
- alias: Notify Dryer Done
  id: 'notify_dryer_done'
  trigger:
    - platform: state
      entity_id: input_boolean.dryer_running
      from: 'on'
      to: 'off'
  action:
    - service: notify.mobile_app_jon_galaxy
      data:
        title: 'Action required:'
        message: 'Dryer has finished, or will be soon.'
        data:
          channel: Home Assistant
    - service: notify.alexa_media
      data:
        target:
          - media_player.everywhere
        data:
          type: announce
        message: 'Dryer has finished, or will be soon.'

# Zigbee device joined 
- alias: Notify Zigbee Device Joined
  id: 'notify_zigbee_device_joined'
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/bridge/event'
  condition:
    condition: template
    value_template: '{{trigger.payload_json.type == "device_interview" and trigger.payload_json.data.status == "successful" and trigger.payload_json.data.supported}}'
  action:
    - service: persistent_notification.create
      data_template:
        title: Device joined the Zigbee2MQTT network
        message: "Name: {{trigger.payload_json.data.friendly_name}},
                  Vendor: {{trigger.payload_json.data.definition.vendor}},
                  Model: {{trigger.payload_json.data.definition.model}},
                  Description: {{trigger.payload_json.data.definition.description}}"
