#========================#
#     Binary Sensors     #
#========================#

- binary_sensor:

    #-----------------------------#
    #   -- Floorplan Mirrors --   #
    #-----------------------------#

    # These sensors are used to create mirror entities to items on the floorplan. For example,
    # there are four wall sconces in the theater, but the floorplan card only allows one element
    # in the SVG file with a given entity ID. By having sensors that mirror that one entity's
    # state, we can then place elements in the SVG file using those sensor IDs.    
    - name: 'Driveway Lights Mirror'
      unique_id: driveway_lights_mirror
      device_class: light
      state: "{{ is_state('switch.driveway_lights', 'on') }}"
    
    - name: 'Garage Lights Mirror'
      unique_id: garage_lights_mirror
      device_class: light
      state: "{{ is_state('switch.garage_lights', 'on') }}"
    
    - name: 'Hallway Lights Mirror'
      unique_id: hallway_lights_mirror
      device_class: light
      state: "{{ is_state('switch.hallway_lights', 'on') }}"
    
    - name: 'Kitchen Light Mirror'
      unique_id: kitchen_light_mirror
      device_class: light
      state: "{{ is_state('switch.kitchen_light', 'on') }}"
    
    - name: 'Penthouse Light Mirror'
      unique_id: penthouse_light_mirror
      device_class: light
      state: "{{ is_state('switch.penthouse_light', 'on') }}"
    
    - name: 'Snack Light Mirror'
      unique_id: snack_light_mirror
      device_class: light
      state: "{{ is_state('switch.snack_light', 'on') }}"
      
    - name: 'Theater Sconces Mirror'
      unique_id: theater_sconces_mirror
      device_class: light
      state: "{{ is_state('light.theater_sconces', 'on') }}"
    
    - name: 'Theater Ceiling Mirror'
      unique_id: theater_ceiling_mirror
      device_class: light
      state: "{{ is_state('light.theater_ceiling', 'on') }}"

    #-------------------------#
    #   -- History Stats --   #
    #-------------------------#
    
    # These sensors are used to support history stats.
    
    # Family Room AV is true if the AV system is drawing power, and a grandchild
    # is not home or a grandchild is home and it's in the evening (I don't count a grandchild
    # watching YouTube or cartoon shows all day).
    - name: 'Family Room AV Usage'
      unique_id: family_room_av_usage
      state: >
        {{ is_state('binary_sensor.family_room_av_system', 'on') and
           (is_state('binary_sensor.children_home', 'off') or
             (is_state('binary_sensor.children_home', 'on') and
              now().strftime('%H') >= '19')) }}
    
    # Theater AV is true if the AV system is drawing power, and the source device is not Shield TV
    # (we can't know if such devices are playing or not) or the source is Shield TV and it's in
    # playing state.
    - name: 'Theater AV Usage'
      unique_id: theater_av_usage
      state: >
        {{ is_state('binary_sensor.theater_av_system', 'on')  and
           (not is_state('sensor.harmony_hub', 'Stream Player') or
             (is_state('sensor.harmony_hub', 'Stream Player') and
              is_state('media_player.shield_tv', 'playing'))) }}

    #------------------------------#
    #   -- Device Power Flags --   #
    #------------------------------#
    
    # These indicate if a device or device group (such as an AV system) are drawing power.
    - name: Family Room AV System
      unique_id: family_room_av_system
      state: "{{ states('sensor.family_room_av_current_consumption') | float(0) > 10 }}"
      
    - name: Theater AV System
      unique_id: theater_av_system
      state: "{{ states('sensor.theater_av_current_consumption') | float(0) > 50 }}"

    #-------------------------#
    #   -- Dryer Control --   #
    #-------------------------#

    # This sensor controls when we turn off the dryer. There are trend sensors to detect temperature and humidity falling,
    # but sometimes these can be spurious, for example getting 2 humidity falling events, then a temperature falling event.
    # So we have a counter for each type of event, and only turn this sensor on when both counters are above zero.
    - name: 'Dryer Done'
      unique_id: dryer_done
      state: "{{ states('counter.dryer_temperature_count') | int(0) > 0 and states('counter.dryer_humidity_count') | int(0) > 0 }}"

    #------------------------------#
    #   -- Presence Detection --   #
    #------------------------------#
    
    # This sensor indicates if any adult family members are home or not.
    - name: Adults Home
      unique_id: adults_home
      state: "{{ states('person.david') == 'home' or states('person.maryam') == 'home' or states('person.mike') == 'home' or states('person.sarah') == 'home' }}"
      device_class: presence
    
    # This sensor indicates if any child family members are home or not.
    - name: Children Home
      unique_id: children_home
      state: "{{ states('person.skylar') == 'home' }}"
      device_class: presence
    
    # Am I home alone?
    - name: Home Alone
      unique_id: home_alone
      state: "{{ states('zone.home') | int(0) == 1 and state_attr('zone.home', 'persons') == ['person.jon'] }}"
      device_class: presence

    #------------------------------#
    #   -- Penthouse Occupied --   #
    #------------------------------#
    
    # Note that the house is considered a device.
    - name: Penthouse Occupied
      unique_id: penthouse_occupied
      state: >
        {{ states('input_select.occupied_bedrooms') in ['AdultUp', 'ChildUp', 'ChildDownPlus', 'ChildUpPlus', 'Both'] }}

    #-----------------------#
    #   -- Delivery UI --   #
    #-----------------------#
    
    # These allow delivery buttons to be hidden when not needed.
    - name: Hide Amazon Delivery
      unique_id: hide_amazon_delivery
      state: >
        {{ (is_state('sensor.mail_amazon_packages', '0') and is_state('sensor.mail_amazon_packages_delivered', '0')) or 
            states('sensor.mail_amazon_packages') in ['unknown', 'unavailable'] or 
            states('sensor.mail_amazon_packages_delivered') in ['unknown', 'unavailable'] }}
    
    - name: Hide FedEx Delivery
      unique_id: hide_fedex_delivery
      state: >
        {{ (is_state('sensor.mail_fedex_delivering', '0') and is_state('sensor.mail_fedex_delivered', '0')) or 
            states('sensor.mail_fedex_delivering') in ['unknown', 'unavailable'] or 
            states('sensor.mail_fedex_delivered') in ['unknown', 'unavailable'] }}
    
    - name: Hide UPS Delivery
      unique_id: hide_ups_delivery
      state: >
        {{ (is_state('sensor.mail_ups_delivering', '0') and is_state('sensor.mail_ups_delivered', '0')) or 
            states('sensor.mail_ups_delivering') in ['unknown', 'unavailable'] or 
            states('sensor.mail_ups_delivered') in ['unknown', 'unavailable'] }}
    
    - name: Hide USPS Delivery
      unique_id: hide_usps_delivery
      state: >
        {{ (is_state('sensor.mail_usps_delivering', '0') and is_state('sensor.mail_usps_delivered', '0')) or 
            states('sensor.mail_usps_delivering') in ['unknown', 'unavailable'] or 
            states('sensor.mail_usps_delivered') in ['unknown', 'unavailable'] }}
