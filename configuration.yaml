#============================#
#     Main Configuration     #
#============================#

# Default setup of Home Assistant (frontend, api, etc)
default_config:

# Front end and themes
frontend:
  themes: !include_dir_merge_named themes
  extra_module_url:
    - /local/community/lovelace-card-mod/card-mod.js

#=====================#
#     Browser Mod     #
#=====================#

browser_mod:
  devices:
    de079a8e_98edec58:
      name: legion
      disable:
        - light
        - media_player

#========================#
#     Included Files     #
#========================#

alexa:          !include alexa.yaml
automation:     !include_dir_merge_list automation
binary_sensor:  !include binary_sensor.yaml
cover:          !include covers.yaml
group:          !include_dir_merge_named group
history:        !include database/history.yaml
influxdb:       !include influxdb.yaml
input_boolean:  !include input_boolean.yaml
input_number:   !include input_number.yaml
input_select:   !include input_select.yaml
logbook:        !include database/logbook.yaml
logger:         !include database/logger.yaml
media_player:   !include media_player.yaml
panel_custom:   !include panel_custom.yaml
recorder:       !include database/recorder.yaml
script:         !include_dir_merge_named script
scene:          !include scenes.yaml
sensor:         !include_dir_merge_list sensor
template:       !include_dir_merge_list template
utility_meter:  !include utility.yaml

#======================#
#     Dashboard UI     #
#======================#

lovelace:
  mode: yaml
  resources: !include dashboard/resources.yaml
  dashboards:
    
    dashboard-overview:
      mode: yaml
      title: Overview
      filename: dashboard_overview.yaml
      show_in_sidebar: true
      require_admin: false
    
    dashboard-reminders:
      mode: yaml
      title: Reminders
      icon: mdi:reminder
      filename: dashboard_reminders.yaml
      show_in_sidebar: true
      require_admin: true

#==================#
#     Presence     #
#==================#

device_tracker:
  - platform: bluetooth_tracker
    interval_seconds: 15
    consider_home: 150
    track_new_devices: true

# Life360
life360:
  accounts:
    - username: !secret life360_username
      password: !secret life360_password

# Proximity
proximity:
  jon_home:
    zone: home
    #ignored_zones:
    #  - dummy
    devices:
      - device_tracker.jon_galaxy
      - device_tracker.life360_jon_franks
    unit_of_measurement: m
  mike_home:
    zone: home
    devices:
      #- device_tracker.mike_galaxy
      - device_tracker.life360_michael_franks
    unit_of_measurement: m
  sarah_home:
    zone: home
    devices:
      - device_tracker.life360_sarah_jones
    unit_of_measurement: m
  #david_home:
  #  zone: home
  #  devices:
  #    - device_tracker.pixel_6_pro
  #  unit_of_measurement: m

#==============#
#     MQTT     #
#==============#

mqtt:
  
  switch:
    
    # Zigbee2MQTT
    - name: Zigbee2MQTT Permit Join
      state_topic: "zigbee2mqtt/bridge/info"
      value_template: "{{ value_json.permit_join | lower }}"
      command_topic: "zigbee2mqtt/bridge/request/permit_join"
      payload_on: "true"
      payload_off: "false"
  
  binary_sensor:
    
    # Room presence
    - name: Garage Espresense Sensor
      state_topic: espresense/rooms/garage/status
      json_attributes_topic: espresense/rooms/garage/telemetry
      payload_on: online
      payload_off: offline
      device_class: connectivity
      
    - name: House Espresense Sensor
      state_topic: espresense/rooms/house/status
      json_attributes_topic: espresense/rooms/house/telemetry
      payload_on: online
      payload_off: offline
      device_class: connectivity
  
  sensor:
    
    # Room presence ... Unfortunately, the MQTT topic for beacon devices includes the name of the scanner closest to the beacon,
    # so we have to have a sensor for each scanner state topic ...

    # ... garage scanner.
    - name: 'Blue Charm Battery Level Garage'
      state_topic: 'espresense/devices/iBeacon:426c7565-4368-6172-6d42-6561636f6e73-3838-4949/garage'
      unit_of_measurement: '%'
      value_template: >
        {% set pct = ((value_json.mV / 1000) / 3.00 * 100) | float(0) | round(0) %}
        {% if pct > 100 %}
          {% set pct = 100 %}
        {% endif %}    
        {{ pct }}
  
    - name: 'Blue Charm Battery Level House'
      state_topic: 'espresense/devices/iBeacon:426c7565-4368-6172-6d42-6561636f6e73-3838-4949/house'
      unit_of_measurement: '%'
      value_template: >
        {% set pct = ((value_json.mV / 1000) / 3.00 * 100) | float(0) | round(0) %}
        {% if pct > 100 %}
          {% set pct = 100 %}
        {% endif %}    
        {{ pct }}    

#==========================#
#     Computer Control     #
#==========================#

wake_on_lan:

#==================#
#     Switches     #
#==================#

switch:
  
  # Amazon Smart Plug ... copies the input boolean of the same name, allowing the plug to be a switch (and thus a light),
  # which in turn allows it to be placed in a group.
  - platform: template
    switches:
      alexa_ha_plug:
        friendly_name: Office Bookcase
        value_template: "{{ is_state('input_boolean.alexa_ha_plug', 'on') }}"
        turn_on:
          - service: input_boolean.turn_on
            entity_id:
              - input_boolean.alexa_ha_plug
        turn_off:
          - service: input_boolean.turn_off
            entity_id:
              - input_boolean.alexa_ha_plug

#=================#
#     Devices     #
#=================#

# Lutron Caseta hub
lutron_caseta:
  host:     !secret lutron_ip_addr
  keyfile:  /ssl/lutron/caseta.key
  certfile: /ssl/lutron/caseta.crt
  ca_certs: /ssl/lutron/caseta-bridge.crt

# Ecovacs DEEBOT
ecovacs:
  username: !secret ecovacs_user_id
  password: !secret ecovacs_password
  country: us
  continent: na
      
#=========================#
#     Thermal Comfort     #
#=========================#

thermal_comfort:
  - sensor:
      - name: Outdoor
        unique_id: 'tc_outdoor'
        temperature_sensor: sensor.porch_temperature
        humidity_sensor: sensor.porch_humidity
        sensor_types:
          - heat_index
          - dew_point

#=======================#
#     Miscellaneous     #
#=======================#

#HTTP, needed for NGINX
http:
  use_x_forwarded_for: true
  trusted_proxies: 
    - 172.30.33.0/24

# System log error detection
system_log:
  fire_event: true

counter:
  kodi_errors:
    name: Kodi Errors
    initial: 0
    restore: false

# Notify service
notify:
  - name: triggered_automations
    platform: file
    filename: triggered_automations.log
  - name: dryer_trend_sensors
    platform: file
    filename: dryer_trend_sensors.log

# Shell commands
shell_command:
  backup_log:               python /config/python/backup_log.py
  backup_auto_log:          python /config/python/backup_auto_log.py
  concat_log_files:         python /config/python/concat_log_files.py
  concat_auto_log_files:    python /config/python/concat_auto_log_files.py
  copy_floorplan_christmas: python /config/python/copy_floorplan_christmas.py
  copy_floorplan_normal:    python /config/python/copy_floorplan_normal.py
  delete_junk_log_files:    'rm -f /config/home-assistant.log.1; rm -f /config/home-assistant.log.fault'
  reboot_nut_service:       bash /config/reboot_nut_server.sh
