#============================#
#     Main Configuration     #
#============================#

# Default setup of Home Assistant (frontend, api, etc)
default_config:

# Front end and themes
frontend:
  themes: !include_dir_merge_named themes
  extra_module_url:
    - /local/community/lovelace-card-mod/card-mod.js

#========================#
#     Included Files     #
#========================#

alexa:          !include database/alexa.yaml
automation:     !include_dir_merge_list automation
binary_sensor:  !include binary_sensor.yaml
cover:          !include covers.yaml
group:          !include_dir_merge_named group
influxdb:       !include database/influxdb.yaml
input_boolean:  !include input_boolean.yaml
input_number:   !include input_number.yaml
input_select:   !include input_select.yaml
logger:         !include database/logger.yaml
media_player:   !include media_player.yaml
panel_custom:   !include panel_custom.yaml
recorder:       !include database/recorder.yaml
script:         !include_dir_merge_named script
scene:          !include scenes.yaml
sensor:         !include_dir_merge_list sensor
template:       !include_dir_merge_list template

#======================#
#     Dashboard UI     #
#======================#

lovelace:
  mode: yaml
  resources: !include dashboard/resources.yaml
  dashboards:
    
    dashboard-overview:
      mode: yaml
      title: Overview
      filename: dashboard_overview.yaml
      show_in_sidebar: true
      require_admin: false
    
    dashboard-reminders:
      mode: yaml
      title: Reminders
      icon: mdi:reminder
      filename: dashboard_reminders.yaml
      show_in_sidebar: true
      require_admin: true

#==================#
#     Presence     #
#==================#

# Proximity
proximity:
  
  jon_home:
    zone: home
    ignored_zones:
      - habitat
      - khan_s
      - m_m
      - s_d
      - ecu
    devices:
      - person.jon
    unit_of_measurement: m
  
  mike_home:
    zone: home
    ignored_zones:
      - habitat
      - khan_s
      - m_m
      - s_d
      - ecu
    devices:
      - person.mike
    unit_of_measurement: m
  
  sarah_home:
    zone: home
    ignored_zones:
      - habitat
      - khan_s
      - m_m
      - s_d
      - ecu
    devices:
      - person.sarah
    unit_of_measurement: m
  
  david_home:
    zone: home
    ignored_zones:
      - habitat
      - khan_s
      - m_m
      - s_d
      - ecu
    devices:
      - person.david
    unit_of_measurement: m

#==============#
#     MQTT     #
#==============#

mqtt:
  
  sensor:
    
    # InfluxDB database size for the front end.
    - name: InfluxDB DB Size
      unit_of_measurement: 'MB'
      icon: hass:chart-line
      state_topic: "homeassistant/sensor/dbsize"
      value_template: "{{ (value.split('\t')[0]|int(0)/1000)|round(3) }}"

#==========================#
#     Computer Control     #
#==========================#

wake_on_lan:

#==================#
#     Switches     #
#==================#

switch:
  
  # Amazon Smart Plug ... copies the input boolean of the same name, allowing the plug to be a switch (and thus a light),
  # which in turn allows it to be placed in a group.
  - platform: template
    switches:
      alexa_ha_plug:
        friendly_name: Office Bookcase
        value_template: "{{ is_state('input_boolean.alexa_ha_plug', 'on') }}"
        turn_on:
          - service: input_boolean.turn_on
            entity_id:
              - input_boolean.alexa_ha_plug
        turn_off:
          - service: input_boolean.turn_off
            entity_id:
              - input_boolean.alexa_ha_plug

#=================#
#     Devices     #
#=================#

# Lutron Caseta hub
lutron_caseta:
  host:     !secret lutron_ip_addr
  keyfile:  /ssl/lutron/caseta.key
  certfile: /ssl/lutron/caseta.crt
  ca_certs: /ssl/lutron/caseta-bridge.crt

# Ecovacs DEEBOT
ecovacs:
  username: !secret ecovacs_user_id
  password: !secret ecovacs_password
  country: us
  continent: na

#=======================#
#     Miscellaneous     #
#=======================#

#HTTP, needed for NGINX (check NGINX add-on log for current values)
http:
  use_x_forwarded_for: true
  trusted_proxies: 
    - 172.30.32.0/24
    - 172.30.33.0/24

# System log error detection
system_log:
  fire_event: true

# Notify service
notify:
  - name: triggered_automations
    platform: file
    filename: debug_logs/triggered_automations.log
  
  - name: triggered_scripts
    platform: file
    filename: debug_logs/triggered_scripts.log
  
  - name: laundry_events
    platform: file
    filename: debug_logs/laundry_events.log

  - name: gmail
    platform: smtp
    server: "smtp.gmail.com"
    port: 587
    timeout: 15
    sender: !secret gmail_email_address
    encryption: starttls
    username: !secret gmail_email_address
    password: !secret gmail_app_password
    recipient:
      - !secret gmail_email_address
    sender_name: Jon Franks

# Command line
command_line:
  - sensor:
      name: CPU Temp
      unit_of_measurement: 'Â°'
      command: 'cat /sys/class/thermal/thermal_zone0/temp'
      value_template: "{{ (value | multiply(0.001) | float(0)) | round(2) }}"

# Shell commands
shell_command:
  backup_log:                     'python /config/python/backup_logs.py /config/home-assistant.log'
  backup_auto_log:                'python /config/python/backup_logs.py /config/debug_logs/triggered_automations.log'
  backup_laundry_log:             'python /config/python/backup_logs.py /config/debug_logs/laundry_events.log'
  backup_scripts_log:             'python /config/python/backup_logs.py /config/debug_logs/triggered_scripts.log'
  concat_log_files:               'python /config/python/concat_logs.py /config/home-assistant'
  concat_auto_log_files:          'python /config/python/concat_logs.py /config/debug_logs/triggered_automations'
  concat_scripts_log_files:       'python /config/python/concat_logs.py /config/debug_logs/triggered_scripts'
  delete_junk_log_files:          'rm -f /config/home-assistant.log.1; rm -f /config/home-assistant.log.fault'
  reboot_nut_service:             bash /config/reboot_nut_server.sh
